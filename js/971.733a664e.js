"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[971],{"5971":function(e,r,t){t.r(r),t.d(r,{"_KTXTextureLoader":function(){return _KTXTextureLoader}});var o=t(658);class KhronosTextureContainer{"constructor"(e,r){if(this.data=e,this.isInvalid=!1,!KhronosTextureContainer.IsValid(e))return this.isInvalid=!0,void o.Y.Error("texture missing KTX identifier");const t=Uint32Array.BYTES_PER_ELEMENT,s=new DataView(this.data.buffer,this.data.byteOffset+12,13*t),n=67305985===s.getUint32(0,!0);return this.glType=s.getUint32(1*t,n),this.glTypeSize=s.getUint32(2*t,n),this.glFormat=s.getUint32(3*t,n),this.glInternalFormat=s.getUint32(4*t,n),this.glBaseInternalFormat=s.getUint32(5*t,n),this.pixelWidth=s.getUint32(6*t,n),this.pixelHeight=s.getUint32(7*t,n),this.pixelDepth=s.getUint32(8*t,n),this.numberOfArrayElements=s.getUint32(9*t,n),this.numberOfFaces=s.getUint32(10*t,n),this.numberOfMipmapLevels=s.getUint32(11*t,n),this.bytesOfKeyValueData=s.getUint32(12*t,n),0!==this.glType?(o.Y.Error("only compressed formats currently supported"),void(this.isInvalid=!0)):(this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0===this.pixelHeight||0!==this.pixelDepth?(o.Y.Error("only 2D textures currently supported"),void(this.isInvalid=!0)):0!==this.numberOfArrayElements?(o.Y.Error("texture arrays not currently supported"),void(this.isInvalid=!0)):this.numberOfFaces!==r?(o.Y.Error("number of faces expected"+r+", but found "+this.numberOfFaces),void(this.isInvalid=!0)):void(this.loadType=KhronosTextureContainer.COMPRESSED_2D))}"uploadLevels"(e,r){switch(this.loadType){case KhronosTextureContainer.COMPRESSED_2D:this._upload2DCompressedLevels(e,r);case KhronosTextureContainer.TEX_2D:case KhronosTextureContainer.COMPRESSED_3D:case KhronosTextureContainer.TEX_3D:}}"_upload2DCompressedLevels"(e,r){let t=KhronosTextureContainer.HEADER_LEN+this.bytesOfKeyValueData,o=this.pixelWidth,s=this.pixelHeight;const n=r?this.numberOfMipmapLevels:1;for(let r=0;r<n;r++){const n=new Int32Array(this.data.buffer,this.data.byteOffset+t,1)[0];t+=4;for(let a=0;a<this.numberOfFaces;a++){const i=new Uint8Array(this.data.buffer,this.data.byteOffset+t,n);e.getEngine()._uploadCompressedDataToTextureDirectly(e,e.format,o,s,i,a,r),t+=n,t+=3-(n+3)%4}o=Math.max(1,.5*o),s=Math.max(1,.5*s)}}static"IsValid"(e){if(e.byteLength>=12){const r=new Uint8Array(e.buffer,e.byteOffset,12);if(171===r[0]&&75===r[1]&&84===r[2]&&88===r[3]&&32===r[4]&&49===r[5]&&49===r[6]&&187===r[7]&&13===r[8]&&10===r[9]&&26===r[10]&&10===r[11])return!0}return!1}}KhronosTextureContainer.HEADER_LEN=64,KhronosTextureContainer.COMPRESSED_2D=0,KhronosTextureContainer.COMPRESSED_3D=1,KhronosTextureContainer.TEX_2D=2,KhronosTextureContainer.TEX_3D=3;class WorkerPool{"constructor"(e){this._pendingActions=new Array,this._workerInfos=e.map(e=>({"workerPromise":Promise.resolve(e),"idle":!0}))}"dispose"(){for(const e of this._workerInfos)e.workerPromise.then(e=>{e.terminate()});this._workerInfos.length=0,this._pendingActions.length=0}"push"(e){this._executeOnIdleWorker(e)||this._pendingActions.push(e)}"_executeOnIdleWorker"(e){for(const r of this._workerInfos)if(r.idle)return this._execute(r,e),!0;return!1}"_execute"(e,r){e.idle=!1,e.workerPromise.then(t=>{r(t,()=>{const r=this._pendingActions.shift();r?this._execute(e,r):e.idle=!0})})}}class AutoReleaseWorkerPool extends WorkerPool{"constructor"(e,r,t=AutoReleaseWorkerPool.DefaultOptions){super([]),this._maxWorkers=e,this._createWorkerAsync=r,this._options=t}"push"(e){if(!this._executeOnIdleWorker(e))if(this._workerInfos.length<this._maxWorkers){const r={"workerPromise":this._createWorkerAsync(),"idle":!1};this._workerInfos.push(r),this._execute(r,e)}else this._pendingActions.push(e)}"_execute"(e,r){e.timeoutId&&(clearTimeout(e.timeoutId),delete e.timeoutId),super._execute(e,(t,o)=>{r(t,()=>{o(),e.idle&&(e.timeoutId=setTimeout(()=>{e.workerPromise.then(e=>{e.terminate()});const r=this._workerInfos.indexOf(e);-1!==r&&this._workerInfos.splice(r,1)},this._options.idleTimeElapsedBeforeRelease))})})}}AutoReleaseWorkerPool.DefaultOptions={"idleTimeElapsedBeforeRelease":1e3};var s,n,a,i=t(8658);function applyConfig(e,r){const t=r?.jsDecoderModule||KTX2DECODER;e&&(e.wasmUASTCToASTC&&(t.LiteTranscoder_UASTC_ASTC.WasmModuleURL=e.wasmUASTCToASTC),e.wasmUASTCToBC7&&(t.LiteTranscoder_UASTC_BC7.WasmModuleURL=e.wasmUASTCToBC7),e.wasmUASTCToRGBA_UNORM&&(t.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=e.wasmUASTCToRGBA_UNORM),e.wasmUASTCToRGBA_SRGB&&(t.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=e.wasmUASTCToRGBA_SRGB),e.wasmUASTCToR8_UNORM&&(t.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=e.wasmUASTCToR8_UNORM),e.wasmUASTCToRG8_UNORM&&(t.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=e.wasmUASTCToRG8_UNORM),e.jsMSCTranscoder&&(t.MSCTranscoder.JSModuleURL=e.jsMSCTranscoder),e.wasmMSCTranscoder&&(t.MSCTranscoder.WasmModuleURL=e.wasmMSCTranscoder),e.wasmZSTDDecoder&&(t.ZSTDDecoder.WasmModuleURL=e.wasmZSTDDecoder)),r&&(r.wasmUASTCToASTC&&(t.LiteTranscoder_UASTC_ASTC.WasmBinary=r.wasmUASTCToASTC),r.wasmUASTCToBC7&&(t.LiteTranscoder_UASTC_BC7.WasmBinary=r.wasmUASTCToBC7),r.wasmUASTCToRGBA_UNORM&&(t.LiteTranscoder_UASTC_RGBA_UNORM.WasmBinary=r.wasmUASTCToRGBA_UNORM),r.wasmUASTCToRGBA_SRGB&&(t.LiteTranscoder_UASTC_RGBA_SRGB.WasmBinary=r.wasmUASTCToRGBA_SRGB),r.wasmUASTCToR8_UNORM&&(t.LiteTranscoder_UASTC_R8_UNORM.WasmBinary=r.wasmUASTCToR8_UNORM),r.wasmUASTCToRG8_UNORM&&(t.LiteTranscoder_UASTC_RG8_UNORM.WasmBinary=r.wasmUASTCToRG8_UNORM),r.jsMSCTranscoder&&(t.MSCTranscoder.JSModule=r.jsMSCTranscoder),r.wasmMSCTranscoder&&(t.MSCTranscoder.WasmBinary=r.wasmMSCTranscoder),r.wasmZSTDDecoder&&(t.ZSTDDecoder.WasmBinary=r.wasmZSTDDecoder))}function workerFunction(e){let r;void 0===e&&"undefined"!=typeof KTX2DECODER&&(e=KTX2DECODER),onmessage=t=>{if(t.data)switch(t.data.action){case"init":{const o=t.data.urls;o&&(o.jsDecoderModule&&void 0===e&&(importScripts(o.jsDecoderModule),e=KTX2DECODER),applyConfig(o)),t.data.wasmBinaries&&applyConfig(void 0,{...t.data.wasmBinaries,"jsDecoderModule":e}),r=new e.KTX2Decoder,postMessage({"action":"init"});break}case"setDefaultDecoderOptions":e.KTX2Decoder.DefaultDecoderOptions=t.data.options;break;case"decode":r.decode(t.data.data,t.data.caps,t.data.options).then(e=>{const r=[];for(let t=0;t<e.mipmaps.length;++t){const o=e.mipmaps[t];o&&o.data&&r.push(o.data.buffer)}postMessage({"action":"decoded","success":!0,"decodedData":e},r)}).catch(e=>{postMessage({"action":"decoded","success":!1,"msg":e})})}}}!function(e){e[e.ETC1S=0]="ETC1S",e[e.UASTC4x4=1]="UASTC4x4"}(s||(s={})),function(e){e[e.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",e[e.BC7_RGBA=1]="BC7_RGBA",e[e.BC3_RGBA=2]="BC3_RGBA",e[e.BC1_RGB=3]="BC1_RGB",e[e.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",e[e.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",e[e.ETC2_RGBA=6]="ETC2_RGBA",e[e.ETC1_RGB=7]="ETC1_RGB",e[e.RGBA32=8]="RGBA32",e[e.R8=9]="R8",e[e.RG8=10]="RG8"}(n||(n={})),function(e){e[e.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",e[e.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.RGBA8Format=32856]="RGBA8Format",e[e.R8Format=33321]="R8Format",e[e.RG8Format=33323]="RG8Format"}(a||(a={}));class KhronosTextureContainer2{static"GetDefaultNumWorkers"(){return"object"==typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static"_Initialize"(e){if(KhronosTextureContainer2._WorkerPoolPromise||KhronosTextureContainer2._DecoderModulePromise)return;const r={"jsDecoderModule":i.w1.GetBabylonScriptURL(this.URLConfig.jsDecoderModule,!0),"wasmUASTCToASTC":i.w1.GetBabylonScriptURL(this.URLConfig.wasmUASTCToASTC,!0),"wasmUASTCToBC7":i.w1.GetBabylonScriptURL(this.URLConfig.wasmUASTCToBC7,!0),"wasmUASTCToRGBA_UNORM":i.w1.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_UNORM,!0),"wasmUASTCToRGBA_SRGB":i.w1.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_SRGB,!0),"wasmUASTCToR8_UNORM":i.w1.GetBabylonScriptURL(this.URLConfig.wasmUASTCToR8_UNORM,!0),"wasmUASTCToRG8_UNORM":i.w1.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRG8_UNORM,!0),"jsMSCTranscoder":i.w1.GetBabylonScriptURL(this.URLConfig.jsMSCTranscoder,!0),"wasmMSCTranscoder":i.w1.GetBabylonScriptURL(this.URLConfig.wasmMSCTranscoder,!0),"wasmZSTDDecoder":i.w1.GetBabylonScriptURL(this.URLConfig.wasmZSTDDecoder,!0)};e&&"function"==typeof Worker&&"undefined"!=typeof URL?KhronosTextureContainer2._WorkerPoolPromise=new Promise(t=>{const o=`${applyConfig}(${workerFunction})()`,s=URL.createObjectURL(new Blob([o],{"type":"application/javascript"}));t(new AutoReleaseWorkerPool(e,()=>function initializeWebWorker(e,r,t){return new Promise((o,s)=>{const onError=r=>{e.removeEventListener("error",onError),e.removeEventListener("message",onMessage),s(r)},onMessage=r=>{"init"===r.data.action&&(e.removeEventListener("error",onError),e.removeEventListener("message",onMessage),o(e))};e.addEventListener("error",onError),e.addEventListener("message",onMessage),e.postMessage({"action":"init","urls":t,"wasmBinaries":r})})}(new Worker(s),void 0,r)))}):void 0===KhronosTextureContainer2._KTX2DecoderModule?KhronosTextureContainer2._DecoderModulePromise=i.w1.LoadBabylonScriptAsync(r.jsDecoderModule).then(()=>(KhronosTextureContainer2._KTX2DecoderModule=KTX2DECODER,KhronosTextureContainer2._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,KhronosTextureContainer2._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,applyConfig(r,KhronosTextureContainer2._KTX2DecoderModule),new KhronosTextureContainer2._KTX2DecoderModule.KTX2Decoder)):(KhronosTextureContainer2._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,KhronosTextureContainer2._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,KhronosTextureContainer2._DecoderModulePromise=Promise.resolve(new KhronosTextureContainer2._KTX2DecoderModule.KTX2Decoder))}"constructor"(e,r=KhronosTextureContainer2.DefaultNumWorkers){this._engine=e;const t="object"==typeof r&&r.workerPool||KhronosTextureContainer2.WorkerPool;if(t)KhronosTextureContainer2._WorkerPoolPromise=Promise.resolve(t);else{"object"==typeof r?KhronosTextureContainer2._KTX2DecoderModule=r?.binariesAndModulesContainer?.jsDecoderModule:"undefined"!=typeof KTX2DECODER&&(KhronosTextureContainer2._KTX2DecoderModule=KTX2DECODER);const e="number"==typeof r?r:r.numWorkers??KhronosTextureContainer2.DefaultNumWorkers;KhronosTextureContainer2._Initialize(e)}}"_uploadAsync"(e,r,t){const o=this._engine.getCaps(),s={"astc":!!o.astc,"bptc":!!o.bptc,"s3tc":!!o.s3tc,"pvrtc":!!o.pvrtc,"etc2":!!o.etc2,"etc1":!!o.etc1};if(KhronosTextureContainer2._WorkerPoolPromise)return KhronosTextureContainer2._WorkerPoolPromise.then(o=>new Promise((n,a)=>{o.push((o,i)=>{const onError=e=>{o.removeEventListener("error",onError),o.removeEventListener("message",onMessage),a(e),i()},onMessage=e=>{if("decoded"===e.data.action){if(o.removeEventListener("error",onError),o.removeEventListener("message",onMessage),e.data.success)try{this._createTexture(e.data.decodedData,r,t),n()}catch(e){a({"message":e})}else a({"message":e.data.msg});i()}};o.addEventListener("error",onError),o.addEventListener("message",onMessage),o.postMessage({"action":"setDefaultDecoderOptions","options":KhronosTextureContainer2.DefaultDecoderOptions._getKTX2DecoderOptions()});const T=new Uint8Array(e.byteLength);T.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),o.postMessage({"action":"decode","data":T,"caps":s,"options":t},[T.buffer])})}));if(KhronosTextureContainer2._DecoderModulePromise)return KhronosTextureContainer2._DecoderModulePromise.then(t=>(KhronosTextureContainer2.DefaultDecoderOptions.isDirty&&(KhronosTextureContainer2._KTX2DecoderModule.KTX2Decoder.DefaultDecoderOptions=KhronosTextureContainer2.DefaultDecoderOptions._getKTX2DecoderOptions()),new Promise((s,n)=>{t.decode(e,o).then(e=>{this._createTexture(e,r),s()}).catch(e=>{n({"message":e})})})));throw new Error("KTX2 decoder module is not available")}"_createTexture"(e,r,t){this._engine._bindTextureDirectly(3553,r),t&&(t.transcodedFormat=e.transcodedFormat,t.isInGammaSpace=e.isInGammaSpace,t.hasAlpha=e.hasAlpha,t.transcoderName=e.transcoderName);let o=!0;switch(e.transcodedFormat){case 32856:r.type=0,r.format=5;break;case 33321:r.type=0,r.format=6;break;case 33323:r.type=0,r.format=7;break;default:r.format=e.transcodedFormat,o=!1}if(r._gammaSpace=e.isInGammaSpace,r.generateMipMaps=e.mipmaps.length>1,e.errors)throw new Error("KTX2 container - could not transcode the data. "+e.errors);for(let t=0;t<e.mipmaps.length;++t){const s=e.mipmaps[t];if(!s||!s.data)throw new Error("KTX2 container - could not transcode one of the image");o?(r.width=s.width,r.height=s.height,this._engine._uploadDataToTextureDirectly(r,s.data,0,t,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(r,e.transcodedFormat,s.width,s.height,s.data,0,t)}r._extension=".ktx2",r.width=e.mipmaps[0].width,r.height=e.mipmaps[0].height,r.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static"IsValid"(e){if(e.byteLength>=12){const r=new Uint8Array(e.buffer,e.byteOffset,12);if(171===r[0]&&75===r[1]&&84===r[2]&&88===r[3]&&32===r[4]&&50===r[5]&&48===r[6]&&187===r[7]&&13===r[8]&&10===r[9]&&26===r[10]&&10===r[11])return!0}return!1}}KhronosTextureContainer2.URLConfig={"jsDecoderModule":"https://cdn.babylonjs.com/babylon.ktx2Decoder.js","wasmUASTCToASTC":null,"wasmUASTCToBC7":null,"wasmUASTCToRGBA_UNORM":null,"wasmUASTCToRGBA_SRGB":null,"wasmUASTCToR8_UNORM":null,"wasmUASTCToRG8_UNORM":null,"jsMSCTranscoder":null,"wasmMSCTranscoder":null,"wasmZSTDDecoder":null},KhronosTextureContainer2.DefaultNumWorkers=KhronosTextureContainer2.GetDefaultNumWorkers(),KhronosTextureContainer2.DefaultDecoderOptions=new class DefaultKTX2DecoderOptions{"constructor"(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get"isDirty"(){return this._isDirty}get"useRGBAIfASTCBC7NotAvailableWhenUASTC"(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set"useRGBAIfASTCBC7NotAvailableWhenUASTC"(e){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==e&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=e,this._isDirty=!0)}get"useRGBAIfOnlyBC1BC3AvailableWhenUASTC"(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set"useRGBAIfOnlyBC1BC3AvailableWhenUASTC"(e){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==e&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=e,this._isDirty=!0)}get"forceRGBA"(){return this._forceRGBA}set"forceRGBA"(e){this._forceRGBA!==e&&(this._forceRGBA=e,this._isDirty=!0)}get"forceR8"(){return this._forceR8}set"forceR8"(e){this._forceR8!==e&&(this._forceR8=e,this._isDirty=!0)}get"forceRG8"(){return this._forceRG8}set"forceRG8"(e){this._forceRG8!==e&&(this._forceRG8=e,this._isDirty=!0)}get"bypassTranscoders"(){return this._bypassTranscoders}set"bypassTranscoders"(e){this._bypassTranscoders!==e&&(this._bypassTranscoders=e,this._isDirty=!0)}"_getKTX2DecoderOptions"(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;const e={"useRGBAIfASTCBC7NotAvailableWhenUASTC":this._useRGBAIfASTCBC7NotAvailableWhenUASTC,"forceRGBA":this._forceRGBA,"forceR8":this._forceR8,"forceRG8":this._forceRG8,"bypassTranscoders":this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(e.transcodeFormatDecisionTree={"UASTC":{"transcodeFormat":[n.BC1_RGB,n.BC3_RGBA],"yes":{"transcodeFormat":n.RGBA32,"engineFormat":32856,"roundToMultiple4":!1}}}),this._ktx2DecoderOptions=e,e}};class _KTXTextureLoader{"constructor"(){this.supportCascades=!1}"loadCubeData"(e,r,t,o){if(Array.isArray(e))return;r._invertVScale=!r.invertY;const s=r.getEngine(),n=new KhronosTextureContainer(e,6),a=n.numberOfMipmapLevels>1&&r.generateMipMaps;s._unpackFlipY(!0),n.uploadLevels(r,r.generateMipMaps),r.width=n.pixelWidth,r.height=n.pixelHeight,s._setCubeMapTextureParams(r,a,n.numberOfMipmapLevels-1),r.isReady=!0,r.onLoadedObservable.notifyObservers(r),r.onLoadedObservable.clear(),o&&o()}"loadData"(e,r,t,s){if(KhronosTextureContainer.IsValid(e)){r._invertVScale=!r.invertY;const o=new KhronosTextureContainer(e,1),s=function mapSRGBToLinear(e){switch(e){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}(o.glInternalFormat);s?(r.format=s,r._useSRGBBuffer=r.getEngine()._getUseSRGBBuffer(!0,r.generateMipMaps),r._gammaSpace=!0):r.format=o.glInternalFormat,t(o.pixelWidth,o.pixelHeight,r.generateMipMaps,!0,()=>{o.uploadLevels(r,r.generateMipMaps)},o.isInvalid)}else if(KhronosTextureContainer2.IsValid(e)){new KhronosTextureContainer2(r.getEngine())._uploadAsync(e,r,s).then(()=>{t(r.width,r.height,r.generateMipMaps,!0,()=>{},!1)},e=>{o.Y.Warn(`Failed to load KTX2 texture data: ${e.message}`),t(0,0,!1,!1,()=>{},!0)})}else o.Y.Error("texture missing KTX identifier"),t(0,0,!1,!1,()=>{},!0)}}}}]);