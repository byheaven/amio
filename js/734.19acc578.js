"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[734,639],{"734":function(e,t,r){r.r(t),r.d(t,{"_ENVTextureLoader":function(){return _ENVTextureLoader}});var s=r(9142),i=r(3242),n=r(3133),a=r(7090),o=r(5341),h=r(3545),d=(r(3797),r(6512)),c=r(9023);r(7963);r(3639);var l=r(480);h.V.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)},Object.defineProperty(h.V.prototype,"sphericalPolynomial",{"get":function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=l.$.ConvertCubeMapTextureToSphericalPolynomial(this),null===this._texture._sphericalPolynomialPromise?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(e=>{this._texture._sphericalPolynomial=e,this._texture._sphericalPolynomialComputed=!0})),null}return null},"set":function(e){this._texture&&(this._texture._sphericalPolynomial=e)},"enumerable":!0,"configurable":!0});const u="image/png",p=[134,22,135,150,246,214,150,54];function GetEnvInfo(e){const t=new DataView(e.buffer,e.byteOffset,e.byteLength);let r=0;for(let e=0;e<p.length;e++)if(t.getUint8(r++)!==p[e])return c.Y.Error("Not a babylon environment map"),null;let s="",i=0;for(;i=t.getUint8(r++);)s+=String.fromCharCode(i);let n=JSON.parse(s);return n=normalizeEnvInfo(n),n.binaryDataPosition=r,n.specular&&(n.specular.lodGenerationScale=n.specular.lodGenerationScale||.8),n}function normalizeEnvInfo(e){if(e.version>2)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "2".`);return 2===e.version?e:e={...e,"version":2,"imageType":u}}function CreateRadianceImageDataArrayBufferViews(e,t){const r=(t=normalizeEnvInfo(t)).specular;let s=Math.log2(t.width);if(s=Math.round(s)+1,r.mipmaps.length!==6*s)throw new Error(`Unsupported specular mipmaps number "${r.mipmaps.length}"`);const i=new Array(s);for(let n=0;n<s;n++){i[n]=new Array(6);for(let s=0;s<6;s++){const a=r.mipmaps[6*n+s];i[n][s]=new Uint8Array(e.buffer,e.byteOffset+t.binaryDataPosition+a.position,a.length)}}return i}function CreateIrradianceImageDataArrayBufferViews(e,t){t=normalizeEnvInfo(t);const r=new Array(6),s=t.irradiance?.irradianceTexture;if(s){if(6!==s.faces.length)throw new Error(`Incorrect irradiance texture faces number "${s.faces.length}"`);for(let i=0;i<6;i++){const n=s.faces[i];r[i]=new Uint8Array(e.buffer,e.byteOffset+t.binaryDataPosition+n.position,n.length)}}return r}function UploadEnvLevelsAsync(e,t,r){const s=(r=normalizeEnvInfo(r)).specular;if(!s)return Promise.resolve([]);e._lodGenerationScale=s.lodGenerationScale;const i=[],n=CreateRadianceImageDataArrayBufferViews(t,r);i.push(UploadRadianceLevelsAsync(e,n,r.imageType));const a=r.irradiance?.irradianceTexture;if(a){const s=CreateIrradianceImageDataArrayBufferViews(t,r);i.push(UploadIrradianceLevelsAsync(e,s,a.size,r.imageType))}return Promise.all(i)}function _OnImageReadyAsync(e,t,r,s,i,n,a,o,h,d,c){return new Promise((l,u)=>{if(r){const r=t.createTexture(null,!0,!0,null,1,null,e=>{u(e)},e);s?.onEffectCreatedObservable.addOnce(o=>{o.executeWhenCompiled(()=>{s.externalTextureSamplerBinding=!0,s.onApply=s=>{s._bindTexture("textureSampler",r),s.setFloat2("scale",1,t._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},t.scenes.length&&(t.scenes[0].postProcessManager.directRender([s],d,!0,n,a),t.restoreDefaultFramebuffer(),r.dispose(),URL.revokeObjectURL(i),l())})})}else{if(t._uploadImageToTexture(c,e,n,a),o){const r=h[a];r&&t._uploadImageToTexture(r._texture,e,n,0)}l()}})}async function UploadRadianceLevelsAsync(e,t,r=u){const s=e.getEngine();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,s.updateTextureSamplingMode(3,e),await _UploadLevelsAsync(e,t,!0,r),e.isReady=!0}async function UploadIrradianceLevelsAsync(e,t,r,s=u){const i=e.getEngine(),n=new o.l(i,5),a=new h.V(i,n);e._irradianceTexture=a,n.isCube=!0,n.format=5,n.type=0,n.generateMipMaps=!0,n._cachedAnisotropicFilteringLevel=null,n.generateMipMaps=!0,n.width=r,n.height=r,i.updateTextureSamplingMode(3,n),await _UploadLevelsAsync(n,[t],!1,s),i.generateMipMapsForCubemap(n),n.isReady=!0}async function _UploadLevelsAsync(e,t,i,a=u){if(!s.w1.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");const c=(0,n.uc)(e.width)+1,l=e.getEngine();let p=!1,f=!1,_=null,g=null,m=null;const b=l.getCaps();b.textureLOD?l._features.supportRenderAndCopyToLodForFloatTextures?b.textureHalfFloatRender&&b.textureHalfFloatLinearFiltering?(p=!0,e.type=2):b.textureFloatRender&&b.textureFloatLinearFiltering&&(p=!0,e.type=1):p=!1:(p=!1,f=i);let R=0;if(p)l.isWebGPU?(R=1,await r.e(780).then(r.bind(r,1780))):await r.e(394).then(r.bind(r,5394)),_=new d.D("rgbdDecode","rgbdDecode",null,null,1,null,3,l,!1,void 0,e.type,void 0,null,!1,void 0,R),e._isRGBD=!1,e.invertY=!1,g=l.createRenderTargetCubeTexture(e.width,{"generateDepthBuffer":!1,"generateMipMaps":!0,"generateStencilBuffer":!1,"samplingMode":3,"type":e.type,"format":5});else if(e._isRGBD=!0,e.invertY=!0,f){const t=3;m={};const r=e._lodGenerationScale,s=e._lodGenerationOffset;for(let i=0;i<t;i++){const n=(c-1)*r+s,a=s+(n-s)*(1-i/(t-1)),d=Math.round(Math.min(Math.max(a,0),n)),u=new o.l(l,2);u.isCube=!0,u.invertY=!0,u.generateMipMaps=!1,l.updateTextureSamplingMode(2,u);const p=new h.V(null);switch(p._isCube=!0,p._texture=u,m[d]=p,i){case 0:e._lodTextureLow=p;break;case 1:e._lodTextureMid=p;break;case 2:e._lodTextureHigh=p}}}const P=[];for(let r=0;r<t.length;r++)for(let s=0;s<6;s++){const i=t[r][s],n=new Blob([i],{"type":a}),o=URL.createObjectURL(n);let h;if(l._features.forceBitmapOverHTMLImageElement)h=l.createImageBitmap(n,{"premultiplyAlpha":"none"}).then(t=>_OnImageReadyAsync(t,l,p,_,o,s,r,f,m,g,e));else{const t=new Image;t.src=o,h=new Promise((i,n)=>{t.onload=()=>{_OnImageReadyAsync(t,l,p,_,o,s,r,f,m,g,e).then(()=>i()).catch(e=>{n(e)})},t.onerror=e=>{n(e)}})}P.push(h)}if(await Promise.all(P),t.length<c){let r;const s=Math.pow(2,c-1-t.length),i=s*s*4;switch(e.type){case 0:r=new Uint8Array(i);break;case 2:r=new Uint16Array(i);break;case 1:r=new Float32Array(i)}for(let s=t.length;s<c;s++)for(let t=0;t<6;t++)l._uploadArrayBufferViewToTexture(g?.texture||e,r,t,s)}if(g){const t=e._irradianceTexture;e._irradianceTexture=null,l._releaseTexture(e),g._swapAndDie(e),e._irradianceTexture=t}_&&_.dispose(),f&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}function UploadEnvSpherical(e,t){const r=(t=normalizeEnvInfo(t)).irradiance;if(!r)return;const s=new a.i;i.P.FromArrayToRef(r.x,0,s.x),i.P.FromArrayToRef(r.y,0,s.y),i.P.FromArrayToRef(r.z,0,s.z),i.P.FromArrayToRef(r.xx,0,s.xx),i.P.FromArrayToRef(r.yy,0,s.yy),i.P.FromArrayToRef(r.zz,0,s.zz),i.P.FromArrayToRef(r.yz,0,s.yz),i.P.FromArrayToRef(r.zx,0,s.zx),i.P.FromArrayToRef(r.xy,0,s.xy),e._sphericalPolynomial=s}class _ENVTextureLoader{"constructor"(){this.supportCascades=!1}"loadCubeData"(e,t,r,s,i){if(Array.isArray(e))return;const n=GetEnvInfo(e);if(n){t.width=n.width,t.height=n.width;try{UploadEnvSpherical(t,n),UploadEnvLevelsAsync(t,e,n).then(()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s()},e=>{i?.("Can not upload environment levels",e)})}catch(e){i?.("Can not upload environment file",e)}}else i&&i("Can not parse the environment file",null)}"loadData"(){throw".env not supported in 2d."}}},"8948":function(e,t,r){r.d(t,{"H":function(){return EffectWrapper},"I":function(){return EffectRenderer}});var s=r(2664),i=r(2331),n=r(5081),a=r(3222),o=r(9072);r(2433);const h={"positions":[1,1,-1,1,-1,-1,1,-1],"indices":[0,1,2,0,2,3]};class EffectRenderer{"constructor"(e,t=h){this._fullscreenViewport=new i.l(0,0,1,1);const r=t.positions??h.positions,n=t.indices??h.indices;this.engine=e,this._vertexBuffers={[s.o.PositionKind]:new s.o(e,r,s.o.PositionKind,!1,!1,2)},this._indexBuffer=e.createIndexBuffer(n),this._onContextRestoredObserver=e.onContextRestoredObservable.add(()=>{this._indexBuffer=e.createIndexBuffer(n);for(const e in this._vertexBuffers){this._vertexBuffers[e]._rebuild()}})}"setViewport"(e=this._fullscreenViewport){this.engine.setViewport(e)}"bindBuffers"(e){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,e)}"applyEffectWrapper"(e){this.engine.setState(!0),this.engine.depthCullingState.depthTest=!1,this.engine.stencilState.stencilTest=!1,this.engine.enableEffect(e.drawWrapper),this.bindBuffers(e.effect),e.onApplyObservable.notifyObservers({})}"saveStates"(){this._savedStateDepthTest=this.engine.depthCullingState.depthTest,this._savedStateStencilTest=this.engine.stencilState.stencilTest}"restoreStates"(){this.engine.depthCullingState.depthTest=this._savedStateDepthTest,this.engine.stencilState.stencilTest=this._savedStateStencilTest}"draw"(){this.engine.drawElementsType(0,0,6)}"_isRenderTargetTexture"(e){return void 0!==e.renderTarget}"render"(e,t=null){if(!e.effect.isReady())return;this.saveStates(),this.setViewport();const r=null===t?null:this._isRenderTargetTexture(t)?t.renderTarget:t;r&&this.engine.bindFramebuffer(r),this.applyEffectWrapper(e),this.draw(),r&&this.engine.unBindFramebuffer(r),this.restoreStates()}"dispose"(){const e=this._vertexBuffers[s.o.PositionKind];e&&(e.dispose(),delete this._vertexBuffers[s.o.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}class EffectWrapper{static"RegisterShaderCodeProcessing"(e,t){t?EffectWrapper._CustomShaderCodeProcessing[e??""]=t:delete EffectWrapper._CustomShaderCodeProcessing[e??""]}static"_GetShaderCodeProcessing"(e){return EffectWrapper._CustomShaderCodeProcessing[e]??EffectWrapper._CustomShaderCodeProcessing[""]}get"name"(){return this.options.name}set"name"(e){this.options.name=e}"isReady"(){return this._drawWrapper.effect?.isReady()??!1}get"drawWrapper"(){return this._drawWrapper}get"effect"(){return this._drawWrapper.effect}set"effect"(e){this._drawWrapper.effect=e}"constructor"(e){this.alphaMode=0,this.onEffectCreatedObservable=new n.y$(void 0,!0),this.onApplyObservable=new n.y$,this._shadersLoaded=!1,this._webGPUReady=!1,this._importPromises=[],this.options={...e,"name":e.name||"effectWrapper","engine":e.engine,"uniforms":e.uniforms||e.uniformNames||[],"uniformNames":void 0,"samplers":e.samplers||e.samplerNames||[],"samplerNames":void 0,"attributeNames":e.attributeNames||["position"],"uniformBuffers":e.uniformBuffers||[],"defines":e.defines||"","useShaderStore":e.useShaderStore||!1,"vertexUrl":e.vertexUrl||e.vertexShader||"postprocess","vertexShader":void 0,"fragmentShader":e.fragmentShader||"pass","indexParameters":e.indexParameters,"blockCompilation":e.blockCompilation||!1,"shaderLanguage":e.shaderLanguage||0,"onCompiled":e.onCompiled||void 0,"extraInitializations":e.extraInitializations||void 0,"extraInitializationsAsync":e.extraInitializationsAsync||void 0,"useAsPostProcess":e.useAsPostProcess??!1},this.options.uniformNames=this.options.uniforms,this.options.samplerNames=this.options.samplers,this.options.vertexShader=this.options.vertexUrl,this.options.useAsPostProcess&&(-1===this.options.samplers.indexOf("textureSampler")&&this.options.samplers.push("textureSampler"),-1===this.options.uniforms.indexOf("scale")&&this.options.uniforms.push("scale")),e.vertexUrl||e.vertexShader?this._shaderPath={"vertexSource":this.options.vertexShader}:(this.options.useAsPostProcess||(this.options.uniforms.push("scale"),this.onApplyObservable.add(()=>{this.effect.setFloat2("scale",1,1)})),this._shaderPath={"vertex":this.options.vertexShader}),this._shaderPath.fragmentSource=this.options.fragmentShader,this._shaderPath.spectorName=this.options.name,this.options.useShaderStore&&(this._shaderPath.fragment=this._shaderPath.fragmentSource,this._shaderPath.vertex||(this._shaderPath.vertex=this._shaderPath.vertexSource),delete this._shaderPath.fragmentSource,delete this._shaderPath.vertexSource),this.onApplyObservable.add(()=>{this.bind()}),this.options.useShaderStore||(this._onContextRestoredObserver=this.options.engine.onContextRestoredObservable.add(()=>{this.effect._pipelineContext=null,this.effect._prepareEffect()})),this._drawWrapper=new o.q(this.options.engine),this._webGPUReady=1===this.options.shaderLanguage;const t=Array.isArray(this.options.defines)?this.options.defines.join("\n"):this.options.defines;this._postConstructor(this.options.blockCompilation,t,this.options.extraInitializations)}"_gatherImports"(e=!1,t){this.options.useAsPostProcess&&(e&&this._webGPUReady?t.push(Promise.all([r.e(771).then(r.bind(r,6771))])):t.push(Promise.all([Promise.resolve().then(r.bind(r,2433))])))}"_postConstructor"(e,t=null,r,s){this._importPromises.length=0,s&&this._importPromises.push(...s);const i=this.options.engine.isWebGPU&&!EffectWrapper.ForceGLSL;this._gatherImports(i,this._importPromises),void 0!==r&&r(i,this._importPromises),i&&this._webGPUReady&&(this.options.shaderLanguage=1),e||this.updateEffect(t)}"updateEffect"(e=null,t=null,r=null,s,i,n,o,h){const d=EffectWrapper._GetShaderCodeProcessing(this.name);if(d?.defineCustomBindings){const s=t?.slice()??[];s.push(...this.options.uniforms);const i=r?.slice()??[];i.push(...this.options.samplers),e=d.defineCustomBindings(this.name,e,s,i),t=s,r=i}this.options.defines=e||"";const c=this._shadersLoaded||0===this._importPromises.length?void 0:async()=>{await Promise.all(this._importPromises),this._shadersLoaded=!0};let l;l=this.options.extraInitializationsAsync?async()=>{c?.(),await this.options.extraInitializationsAsync()}:c,this.options.useShaderStore?this._drawWrapper.effect=this.options.engine.createEffect({"vertex":o??this._shaderPath.vertex,"fragment":h??this._shaderPath.fragment},{"attributes":this.options.attributeNames,"uniformsNames":t||this.options.uniforms,"uniformBuffersNames":this.options.uniformBuffers,"samplers":r||this.options.samplers,"defines":null!==e?e:"","fallbacks":null,"onCompiled":i??this.options.onCompiled,"onError":n??null,"indexParameters":s||this.options.indexParameters,"processCodeAfterIncludes":d?.processCodeAfterIncludes?(e,t)=>d.processCodeAfterIncludes(this.name,e,t):null,"processFinalCode":d?.processFinalCode?(e,t)=>d.processFinalCode(this.name,e,t):null,"shaderLanguage":this.options.shaderLanguage,"extraInitializationsAsync":l},this.options.engine):this._drawWrapper.effect=new a.Q(this._shaderPath,this.options.attributeNames,t||this.options.uniforms,r||this.options.samplerNames,this.options.engine,e,void 0,i||this.options.onCompiled,void 0,void 0,void 0,this.options.shaderLanguage,l),this.onEffectCreatedObservable.notifyObservers(this._drawWrapper.effect)}"bind"(){this.options.useAsPostProcess&&(this.options.engine.setAlphaMode(this.alphaMode),this.drawWrapper.effect.setFloat2("scale",1,1)),EffectWrapper._GetShaderCodeProcessing(this.name)?.bindCustomBindings?.(this.name,this._drawWrapper.effect)}"dispose"(e=!1){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.onEffectCreatedObservable.clear(),this._drawWrapper.dispose(!0)}}EffectWrapper.ForceGLSL=!1,EffectWrapper._CustomShaderCodeProcessing={}},"480":function(e,t,r){r.d(t,{"$":function(){return CubeMapToSphericalPolynomialTools}});var s=r(3242),i=r(3133),n=r(7090),a=r(7877),o=r(7019);class FileFaceOrientation{"constructor"(e,t,r,s){this.name=e,this.worldAxisForNormal=t,this.worldAxisForFileX=r,this.worldAxisForFileY=s}}class CubeMapToSphericalPolynomialTools{static"ConvertCubeMapTextureToSphericalPolynomial"(e){if(!e.isCube)return null;e.getScene()?.getEngine().flushFramebuffer();const t=e.getSize().width,r=e.readPixels(0,void 0,void 0,!1),s=e.readPixels(1,void 0,void 0,!1);let i,n;e.isRenderTarget?(i=e.readPixels(3,void 0,void 0,!1),n=e.readPixels(2,void 0,void 0,!1)):(i=e.readPixels(2,void 0,void 0,!1),n=e.readPixels(3,void 0,void 0,!1));const a=e.readPixels(4,void 0,void 0,!1),o=e.readPixels(5,void 0,void 0,!1),h=e.gammaSpace;let d=0;return 1!=e.textureType&&2!=e.textureType||(d=1),new Promise(e=>{Promise.all([s,r,i,n,a,o]).then(([r,s,i,n,a,o])=>{const c={"size":t,"right":s,"left":r,"up":i,"down":n,"front":a,"back":o,"format":5,"type":d,"gammaSpace":h};e(this.ConvertCubeMapToSphericalPolynomial(c))})})}static"_AreaElement"(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}static"ConvertCubeMapToSphericalPolynomial"(e){const t=new n._;let r=0;const s=2/e.size,h=s,d=.5*s,c=d-1;for(let n=0;n<6;n++){const l=this._FileFaces[n],u=e[l.name];let p=c;const f=5===e.format?4:3;for(let n=0;n<e.size;n++){let _=c;for(let h=0;h<e.size;h++){const c=l.worldAxisForFileX.scale(_).add(l.worldAxisForFileY.scale(p)).add(l.worldAxisForNormal);c.normalize();const g=this._AreaElement(_-d,p-d)-this._AreaElement(_-d,p+d)-this._AreaElement(_+d,p-d)+this._AreaElement(_+d,p+d);let m=u[n*e.size*f+h*f+0],b=u[n*e.size*f+h*f+1],R=u[n*e.size*f+h*f+2];isNaN(m)&&(m=0),isNaN(b)&&(b=0),isNaN(R)&&(R=0),0===e.type&&(m/=255,b/=255,R/=255),e.gammaSpace&&(m=Math.pow((0,i.Lh)(m),a.Nn),b=Math.pow((0,i.Lh)(b),a.Nn),R=Math.pow((0,i.Lh)(R),a.Nn));const P=this.MAX_HDRI_VALUE;if(this.PRESERVE_CLAMPED_COLORS){const e=Math.max(m,b,R);if(e>P){const t=P/e;m*=t,b*=t,R*=t}}else m=(0,i.Lh)(m,0,P),b=(0,i.Lh)(b,0,P),R=(0,i.Lh)(R,0,P);const v=new o.Wo(m,b,R);t.addLight(c,v,g),r+=g,_+=s}p+=h}}const l=6*(4*Math.PI)/6/r;return t.scaleInPlace(l),t.convertIncidentRadianceToIrradiance(),t.convertIrradianceToLambertianRadiance(),n.i.FromHarmonics(t)}}CubeMapToSphericalPolynomialTools._FileFaces=[new FileFaceOrientation("right",new s.P(1,0,0),new s.P(0,0,-1),new s.P(0,-1,0)),new FileFaceOrientation("left",new s.P(-1,0,0),new s.P(0,0,1),new s.P(0,-1,0)),new FileFaceOrientation("up",new s.P(0,1,0),new s.P(1,0,0),new s.P(0,0,1)),new FileFaceOrientation("down",new s.P(0,-1,0),new s.P(1,0,0),new s.P(0,0,-1)),new FileFaceOrientation("front",new s.P(0,0,1),new s.P(1,0,0),new s.P(0,-1,0)),new FileFaceOrientation("back",new s.P(0,0,-1),new s.P(-1,0,0),new s.P(0,-1,0))],CubeMapToSphericalPolynomialTools.MAX_HDRI_VALUE=4096,CubeMapToSphericalPolynomialTools.PRESERVE_CLAMPED_COLORS=!1},"3639":function(e,t,r){r.r(t),r.d(t,{"Dispose":function(){return Dispose},"DumpData":function(){return DumpData},"DumpDataAsync":function(){return DumpDataAsync},"DumpFramebuffer":function(){return DumpFramebuffer},"DumpTools":function(){return d}});var s=r(8948),i=r(9142),n=r(3133),a=r(103);let o,h=null;async function DumpFramebuffer(e,t,r,s,i="image/png",n,a){const o=await r.readPixels(0,0,e,t);DumpData(e,t,new Uint8Array(o.buffer),s,i,n,!0,void 0,a)}function DumpDataAsync(e,t,r,s="image/png",i,n=!1,a=!1,o){return new Promise(h=>{DumpData(e,t,r,e=>h(e),s,i,n,a,o)})}function DumpData(e,t,d,c,l="image/png",u,p=!1,f=!1,_){(async function _CreateDumpRenderer(){return h||(h=new Promise((e,t)=>{let i,n=null;const h={"preserveDrawingBuffer":!0,"depth":!1,"stencil":!1,"alpha":!0,"premultipliedAlpha":!1,"antialias":!1,"failIfMajorPerformanceCaveat":!1};Promise.resolve().then(r.bind(r,3158)).then(({"ThinEngine":d})=>{const c=a.l.Instances.length;try{i=new OffscreenCanvas(100,100),n=new d(i,!1,h)}catch(e){c<a.l.Instances.length&&a.l.Instances.pop()?.dispose(),i=document.createElement("canvas"),n=new d(i,!1,h)}a.l.Instances.pop(),a.l.OnEnginesDisposedObservable.add(e=>{n&&e!==n&&!n.isDisposed&&0===a.l.Instances.length&&Dispose()}),n.getCaps().parallelShaderCompile=void 0;const l=new s.I(n);r.e(675).then(r.bind(r,6675)).then(({"passPixelShader":r})=>{if(!n)return void t("Engine is not defined");const a=new s.H({"engine":n,"name":r.name,"fragmentShader":r.shader,"samplerNames":["textureSampler"]});o={"canvas":i,"engine":n,"renderer":l,"wrapper":a},e(o)})}).catch(t)})),await h})().then(r=>{if(r.engine.setSize(e,t,!0),d instanceof Float32Array){const e=new Uint8Array(d.length);let t=d.length;for(;t--;){const r=d[t];e[t]=Math.round(255*(0,n.Lh)(r))}d=e}const s=r.engine.createRawTexture(d,e,t,5,!1,!p,1);r.renderer.setViewport(),r.renderer.applyEffectWrapper(r.wrapper),r.wrapper.effect._bindTexture("textureSampler",s),r.renderer.draw(),f?i.w1.ToBlob(r.canvas,e=>{const t=new FileReader;t.onload=e=>{const t=e.target.result;c&&c(t)},t.readAsArrayBuffer(e)},l,_):i.w1.EncodeScreenshotCanvasData(r.canvas,c,l,u,_),s.dispose()})}function Dispose(){o?(o.wrapper.dispose(),o.renderer.dispose(),o.engine.dispose()):h?.then(e=>{e.wrapper.dispose(),e.renderer.dispose(),e.engine.dispose()}),h=null,o=null}const d={"DumpData":DumpData,"DumpDataAsync":DumpDataAsync,"DumpFramebuffer":DumpFramebuffer,"Dispose":Dispose};i.w1.DumpData=DumpData,i.w1.DumpDataAsync=DumpDataAsync,i.w1.DumpFramebuffer=DumpFramebuffer},"7963":function(e,t,r){r.d(t,{"$0":function(){return ApplyPostProcess},"qZ":function(){return FromHalfFloat},"ay":function(){return ToHalfFloat}});var s=r(4639),i=r(5081),n=r(3242),a=r(9495),o=r(6313),h=r(3222),d=r(9023),c=r(5423),l=r(6788);class ObjectRenderer{get"renderList"(){return this._renderList}set"renderList"(e){this._renderList!==e&&(this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),e&&(this._unObserveRenderList=(0,l.Mf)(e,this._renderListHasChanged)),this._renderList=e)}get"renderInLinearSpace"(){return this._renderInLinearSpace}set"renderInLinearSpace"(e){e!==this._renderInLinearSpace&&(this._renderInLinearSpace=e,this._scene.markAllMaterialsAsDirty(64))}get"name"(){return this._name}set"name"(e){if(this._name===e)return;if(this._name=e,!this._scene)return;const t=this._scene.getEngine();for(let e=0;e<this._renderPassIds.length;++e){const r=this._renderPassIds[e];t._renderPassNames[r]=`${this._name}#${e}`}}get"renderPassIds"(){return this._renderPassIds}get"currentRefreshId"(){return this._currentRefreshId}"setMaterialForRendering"(e,t){let r;r=Array.isArray(e)?e:[e];for(let e=0;e<r.length;++e)for(let s=0;s<this.options.numPasses;++s)r[e].setMaterialForRenderPass(this._renderPassIds[s],void 0!==t?Array.isArray(t)?t[s]:t:void 0)}"constructor"(e,t,r){this._unObserveRenderList=null,this._renderListHasChanged=(e,t)=>{const r=this._renderList?this._renderList.length:0;(0===t&&r>0||0===r)&&this._scene.meshes.forEach(e=>{e._markSubMeshesAsLightDirty()})},this.particleSystemList=null,this.getCustomRenderList=null,this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this._renderInLinearSpace=!1,this.onBeforeRenderObservable=new i.y$,this.onAfterRenderObservable=new i.y$,this.onBeforeRenderingManagerRenderObservable=new i.y$,this.onAfterRenderingManagerRenderObservable=new i.y$,this.onFastPathRenderObservable=new i.y$,this._currentRefreshId=-1,this._refreshRate=1,this._currentApplyByPostProcessSetting=!1,this._currentSceneCamera=null,this.name=e,this._scene=t,this.renderList=[],this._renderPassIds=[],this.options={"numPasses":1,"doNotChangeAspectRatio":!0,...r},this._createRenderPassId(),this.renderPassId=this._renderPassIds[0],this._renderingManager=new c.$(t),this._renderingManager._useSceneAutoClearSetup=!0}"_releaseRenderPassId"(){const e=this._scene.getEngine();for(let t=0;t<this.options.numPasses;++t)e.releaseRenderPassId(this._renderPassIds[t]);this._renderPassIds.length=0}"_createRenderPassId"(){this._releaseRenderPassId();const e=this._scene.getEngine();for(let t=0;t<this.options.numPasses;++t)this._renderPassIds[t]=e.createRenderPassId(`${this.name}#${t}`)}"resetRefreshCounter"(){this._currentRefreshId=-1}get"refreshRate"(){return this._refreshRate}set"refreshRate"(e){this._refreshRate=e,this.resetRefreshCounter()}"shouldRender"(){return-1===this._currentRefreshId||this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}"isReadyForRendering"(e,t){this.prepareRenderList(),this.initRender(e,t);const r=this._checkReadiness();return this.finishRender(),r}"prepareRenderList"(){const e=this._scene;if(this._waitingRenderList){if(!this.renderListPredicate){this.renderList=[];for(let t=0;t<this._waitingRenderList.length;t++){const r=this._waitingRenderList[t],s=e.getMeshById(r);s&&this.renderList.push(s)}}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const e=this._scene.meshes;for(let t=0;t<e.length;t++){const r=e[t];this.renderListPredicate(r)&&this.renderList.push(r)}}this._currentApplyByPostProcessSetting=this._scene.imageProcessingConfiguration.applyByPostProcess,this._scene.imageProcessingConfiguration._applyByPostProcess=!!this._renderInLinearSpace}"initRender"(e,t){const r=this._scene.getEngine(),s=this.activeCamera??this._scene.activeCamera;this._currentSceneCamera=this._scene.activeCamera,s&&(s!==this._scene.activeCamera&&(this._scene.setTransformMatrix(s.getViewMatrix(),s.getProjectionMatrix(!0)),this._scene.activeCamera=s),r.setViewport(s.rigParent?s.rigParent.viewport:s.viewport,e,t)),this._defaultRenderListPrepared=!1}"finishRender"(){const e=this._scene;e.imageProcessingConfiguration._applyByPostProcess=this._currentApplyByPostProcessSetting,e.activeCamera=this._currentSceneCamera,this._currentSceneCamera&&(this.activeCamera&&this.activeCamera!==e.activeCamera&&e.setTransformMatrix(this._currentSceneCamera.getViewMatrix(),this._currentSceneCamera.getProjectionMatrix(!0)),e.getEngine().setViewport(this._currentSceneCamera.viewport)),e.resetCachedMaterial()}"render"(e=0,t=!1){const r=this._scene,s=r.getEngine(),i=s.currentRenderPassId;s.currentRenderPassId=this._renderPassIds[e],this.onBeforeRenderObservable.notifyObservers(e);if(s.snapshotRendering&&1===s.snapshotRenderingMode)this.onFastPathRenderObservable.notifyObservers(e);else{let t=null;const s=this.renderList?this.renderList:r.getActiveMeshes().data,i=this.renderList?this.renderList.length:r.getActiveMeshes().length;this.getCustomRenderList&&(t=this.getCustomRenderList(e,s,i)),t?this._prepareRenderingManager(t,t.length,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(s,i,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),t=s),this.onBeforeRenderingManagerRenderObservable.notifyObservers(e),this._renderingManager.render(this.customRenderFunction,t,this.renderParticles,this.renderSprites),this.onAfterRenderingManagerRenderObservable.notifyObservers(e)}t||this.onAfterRenderObservable.notifyObservers(e),s.currentRenderPassId=i}"_checkReadiness"(){const e=this._scene,t=e.getEngine(),r=t.currentRenderPassId;let s=!0;e.getViewMatrix()||e.updateTransformMatrix();const i=this.options.numPasses;for(let r=0;r<i&&s;r++){let n=null;const a=this.renderList?this.renderList:e.getActiveMeshes().data,o=this.renderList?this.renderList.length:e.getActiveMeshes().length;t.currentRenderPassId=this._renderPassIds[r],this.onBeforeRenderObservable.notifyObservers(r),this.getCustomRenderList&&(n=this.getCustomRenderList(r,a,o)),n||(n=a),this.options.doNotChangeAspectRatio||e.updateTransformMatrix(!0);for(let e=0;e<n.length&&s;++e){const t=n[e];if(t.isEnabled()&&!t.isBlocked&&t.isVisible&&t.subMeshes)if(this.customIsReadyFunction){if(!this.customIsReadyFunction(t,this.refreshRate,!0)){s=!1;continue}}else if(!t.isReady(!0)){s=!1;continue}}this.onAfterRenderObservable.notifyObservers(r),i>1&&(e.incrementRenderId(),e.resetCachedMaterial())}const n=this.particleSystemList||e.particleSystems;for(const e of n)e.isReady()||(s=!1);return t.currentRenderPassId=r,s}"_prepareRenderingManager"(e,t,r){const s=this._scene,i=s.activeCamera,n=this.cameraForLOD??i;this._renderingManager.reset();const a=s.getRenderId(),o=s.getFrameId();for(let h=0;h<t;h++){const t=e[h];if(t&&!t.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(t,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!t.isReady(0===this.refreshRate)){this.resetRefreshCounter();continue}let e,h=null;if(n){const e=t._internalAbstractMeshDataInfo._currentLOD.get(n);e&&e[1]===o?h=e[0]:(h=s.customLODSelector?s.customLODSelector(t,n):t.getLOD(n),e?(e[0]=h,e[1]=o):t._internalAbstractMeshDataInfo._currentLOD.set(n,[h,o]))}else h=t;if(!h)continue;if(h!==t&&0!==h.billboardMode&&h.computeWorldMatrix(),h._preActivateForIntermediateRendering(a),e=!(!r||!i)&&0===(t.layerMask&i.layerMask),t.isEnabled()&&t.isVisible&&t.subMeshes&&!e){if(h!==t&&h._activate(a,!0),t._activate(a,!0)&&t.subMeshes.length){t.isAnInstance?t._internalAbstractMeshDataInfo._actAsRegularMesh&&(h=t):h._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,h._internalAbstractMeshDataInfo._isActiveIntermediate=!0,s._prepareSkeleton(h);for(let e=0;e<h.subMeshes.length;e++){const t=h.subMeshes[e];this._renderingManager.dispatch(t,h)}}t._postActivate()}}}const h=this.particleSystemList||s.particleSystems;for(let e=0;e<h.length;e++){const t=h[e],r=t.emitter;t.isStarted()&&r&&(!r.position||r.isEnabled())&&this._renderingManager.dispatchParticles(t)}}"setRenderingOrder"(e,t=null,r=null,s=null){this._renderingManager.setRenderingOrder(e,t,r,s)}"setRenderingAutoClearDepthStencil"(e,t,r=!0,s=!0){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,r,s),this._renderingManager._useSceneAutoClearSetup=!1}"clone"(){const e=new ObjectRenderer(this.name,this._scene,this.options);return this.renderList&&(e.renderList=this.renderList.slice(0)),e}"dispose"(){const e=this.renderList?this.renderList:this._scene.getActiveMeshes().data,t=this.renderList?this.renderList.length:this._scene.getActiveMeshes().length;for(let r=0;r<t;r++){const t=e[r];void 0!==t.getMaterialForRenderPass(this.renderPassId)&&t.setMaterialForRenderPass(this.renderPassId,void 0)}this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderingManagerRenderObservable.clear(),this.onAfterRenderingManagerRenderObservable.clear(),this.onFastPathRenderObservable.clear(),this._releaseRenderPassId(),this.renderList=null}"_rebuild"(){this.refreshRate===ObjectRenderer.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=ObjectRenderer.REFRESHRATE_RENDER_ONCE)}"freeRenderingGroups"(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}}ObjectRenderer.REFRESHRATE_RENDER_ONCE=0,ObjectRenderer.REFRESHRATE_RENDER_ONEVERYFRAME=1,ObjectRenderer.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,h.Q.prototype.setDepthStencilTexture=function(e,t){this._engine.setDepthStencilTexture(this._samplers[e],this._uniforms[e],t,e)};class RenderTargetTexture extends s.x{get"renderListPredicate"(){return this._objectRenderer.renderListPredicate}set"renderListPredicate"(e){this._objectRenderer.renderListPredicate=e}get"renderList"(){return this._objectRenderer.renderList}set"renderList"(e){this._objectRenderer.renderList=e}get"particleSystemList"(){return this._objectRenderer.particleSystemList}set"particleSystemList"(e){this._objectRenderer.particleSystemList=e}get"getCustomRenderList"(){return this._objectRenderer.getCustomRenderList}set"getCustomRenderList"(e){this._objectRenderer.getCustomRenderList=e}get"renderParticles"(){return this._objectRenderer.renderParticles}set"renderParticles"(e){this._objectRenderer.renderParticles=e}get"renderSprites"(){return this._objectRenderer.renderSprites}set"renderSprites"(e){this._objectRenderer.renderSprites=e}get"forceLayerMaskCheck"(){return this._objectRenderer.forceLayerMaskCheck}set"forceLayerMaskCheck"(e){this._objectRenderer.forceLayerMaskCheck=e}get"activeCamera"(){return this._objectRenderer.activeCamera}set"activeCamera"(e){this._objectRenderer.activeCamera=e}get"cameraForLOD"(){return this._objectRenderer.cameraForLOD}set"cameraForLOD"(e){this._objectRenderer.cameraForLOD=e}get"renderInLinearSpace"(){return this._objectRenderer.renderInLinearSpace}set"renderInLinearSpace"(e){this._objectRenderer.renderInLinearSpace=e}get"customIsReadyFunction"(){return this._objectRenderer.customIsReadyFunction}set"customIsReadyFunction"(e){this._objectRenderer.customIsReadyFunction=e}get"customRenderFunction"(){return this._objectRenderer.customRenderFunction}set"customRenderFunction"(e){this._objectRenderer.customRenderFunction=e}get"postProcesses"(){return this._postProcesses}get"_prePassEnabled"(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set"onAfterUnbind"(e){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(e)}get"onBeforeRenderObservable"(){return this._objectRenderer.onBeforeRenderObservable}set"onBeforeRender"(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}get"onAfterRenderObservable"(){return this._objectRenderer.onAfterRenderObservable}set"onAfterRender"(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}set"onClear"(e){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(e)}get"_waitingRenderList"(){return this._objectRenderer._waitingRenderList}set"_waitingRenderList"(e){this._objectRenderer._waitingRenderList=e}get"renderPassId"(){return this._objectRenderer.renderPassId}get"renderPassIds"(){return this._objectRenderer.renderPassIds}get"currentRefreshId"(){return this._objectRenderer.currentRefreshId}"setMaterialForRendering"(e,t){this._objectRenderer.setMaterialForRendering(e,t)}get"isMulti"(){return this._renderTarget?.isMulti??!1}get"renderTargetOptions"(){return this._renderTargetOptions}get"renderTarget"(){return this._renderTarget}"_onRatioRescale"(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set"boundingBoxSize"(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get"boundingBoxSize"(){return this._boundingBoxSize}get"depthStencilTexture"(){return this._renderTarget?._depthStencilTexture??null}"constructor"(e,t,r,a=!1,o=!0,h=0,c=!1,l=s.x.TRILINEAR_SAMPLINGMODE,u=!0,p=!1,f=!1,_=5,g=!1,m,b,R=!1,P=!1){let v,x,T=!0;if("object"==typeof a){const e=a;a=!!e.generateMipMaps,o=e.doNotChangeAspectRatio??!0,h=e.type??0,c=!!e.isCube,l=e.samplingMode??s.x.TRILINEAR_SAMPLINGMODE,u=e.generateDepthBuffer??!0,p=!!e.generateStencilBuffer,f=!!e.isMulti,_=e.format??5,g=!!e.delayAllocation,m=e.samples,b=e.creationFlags,R=!!e.noColorAttachment,P=!!e.useSRGBBuffer,v=e.colorAttachment,T=e.gammaSpace??T,x=e.existingObjectRenderer}if(super(null,r,!a,void 0,l,void 0,void 0,void 0,void 0,_),this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new i.y$,this.onAfterUnbindObservable=new i.y$,this.onClearObservable=new i.y$,this.onResizeObservable=new i.y$,this._cleared=!1,this.skipInitialClear=!1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this._dontDisposeObjectRenderer=!1,this.boundingBoxPosition=n.P.Zero(),this._disableEngineStages=!1,this._dumpToolsLoading=!1,!(r=this.getScene()))return;const y=this.getScene().getEngine();this._gammaSpace=T,this._coordinatesMode=s.x.PROJECTION_MODE,this.name=e,this.isRenderTarget=!0,this._initialSizeParameter=t,this._dontDisposeObjectRenderer=!!x,this._processSizeParameter(t),this._objectRenderer=x??new ObjectRenderer(e,r,{"numPasses":c?6:this.getRenderLayers()||1,"doNotChangeAspectRatio":o}),this._onBeforeRenderingManagerRenderObserver=this._objectRenderer.onBeforeRenderingManagerRenderObservable.add(()=>{if(!this._disableEngineStages)for(const e of this._scene._beforeRenderTargetClearStage)e.action(this,this._currentFaceIndex,this._currentLayer);if(this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(y):this.skipInitialClear||y.clear(this.clearColor||this._scene.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),!this._disableEngineStages)for(const e of this._scene._beforeRenderTargetDrawStage)e.action(this,this._currentFaceIndex,this._currentLayer)}),this._onAfterRenderingManagerRenderObserver=this._objectRenderer.onAfterRenderingManagerRenderObservable.add(()=>{if(!this._disableEngineStages)for(const e of this._scene._afterRenderTargetDrawStage)e.action(this,this._currentFaceIndex,this._currentLayer);const e=this._texture?.generateMipMaps??!1;if(this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex,this._postProcesses,this.ignoreCameraViewport):this._currentUseCameraPostProcess&&this._scene.postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex),!this._disableEngineStages)for(const e of this._scene._afterRenderTargetPostProcessStage)e.action(this,this._currentFaceIndex,this._currentLayer);this._texture&&(this._texture.generateMipMaps=e),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),this._currentDumpForDebug&&(this._dumpTools?this._dumpTools.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),y):d.Y.Error("dumpTools module is still being loaded. To speed up the process import dump tools directly in your project"))}),this._onFastPathRenderObserver=this._objectRenderer.onFastPathRenderObservable.add(()=>{this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(y):this.skipInitialClear||y.clear(this.clearColor||this._scene.clearColor,!0,!0,!0)}),this._resizeObserver=y.onResizeObservable.add(()=>{}),this._generateMipMaps=!!a,this._doNotChangeAspectRatio=o,f||(this._renderTargetOptions={"generateMipMaps":a,"type":h,"format":this._format??void 0,"samplingMode":this.samplingMode,"generateDepthBuffer":u,"generateStencilBuffer":p,"samples":m,"creationFlags":b,"noColorAttachment":R,"useSRGBBuffer":P,"colorAttachment":v,"label":this.name},this.samplingMode===s.x.NEAREST_SAMPLINGMODE&&(this.wrapU=s.x.CLAMP_ADDRESSMODE,this.wrapV=s.x.CLAMP_ADDRESSMODE),g||(c?(this._renderTarget=r.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=s.x.INVCUBIC_MODE,this._textureMatrix=n.y3.Identity()):this._renderTarget=r.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==m&&(this.samples=m)))}"createDepthStencilTexture"(e=0,t=!0,r=!1,s=1,i=14,n){this._renderTarget?.createDepthStencilTexture(e,t,r,s,i,n)}"_processSizeParameter"(e){if(e.ratio){this._sizeRatio=e.ratio;const t=this._getEngine();this._size={"width":this._bestReflectionRenderTargetDimension(t.getRenderWidth(),this._sizeRatio),"height":this._bestReflectionRenderTargetDimension(t.getRenderHeight(),this._sizeRatio)}}else this._size=e}get"samples"(){return this._renderTarget?.samples??this._samples}set"samples"(e){this._renderTarget&&(this._samples=this._renderTarget.setSamples(e))}"addPostProcess"(e){if(!this._postProcessManager){const e=this.getScene();if(!e)return;this._postProcessManager=new a.O(e),this._postProcesses=new Array}this._postProcesses.push(e),this._postProcesses[0].autoClear=!1}"clearPostProcesses"(e=!1){if(this._postProcesses){if(e)for(const e of this._postProcesses)e.dispose();this._postProcesses=[]}}"removePostProcess"(e){if(!this._postProcesses)return;const t=this._postProcesses.indexOf(e);-1!==t&&(this._postProcesses.splice(t,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}"resetRefreshCounter"(){this._objectRenderer.resetRefreshCounter()}get"refreshRate"(){return this._objectRenderer.refreshRate}set"refreshRate"(e){this._objectRenderer.refreshRate=e}"_shouldRender"(){return this._objectRenderer.shouldRender()}"getRenderSize"(){return this.getRenderWidth()}"getRenderWidth"(){return this._size.width?this._size.width:this._size}"getRenderHeight"(){return this._size.width?this._size.height:this._size}"getRenderLayers"(){const e=this._size.layers;if(e)return e;const t=this._size.depth;return t||0}"disableRescaling"(){this._canRescale=!1}get"canRescale"(){return this._canRescale}"scale"(e){const t=Math.max(1,this.getRenderSize()*e);this.resize(t)}"getReflectionTextureMatrix"(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}"resize"(e){const t=this.isCube;this._renderTarget?.dispose(),this._renderTarget=null;const r=this.getScene();r&&(this._processSizeParameter(e),this._renderTarget=t?r.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):r.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,void 0!==this._renderTargetOptions.samples&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}"render"(e=!1,t=!1){this._render(e,t)}"isReadyForRendering"(){this._dumpToolsLoading||(this._dumpToolsLoading=!0,r.e(639).then(r.bind(r,3639)).then(e=>this._dumpTools=e)),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight());const e=this._objectRenderer._checkReadiness();return this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender(),e}"_render"(e=!1,t=!1){const r=this.getScene();if(r){if(void 0!==this.useCameraPostProcesses&&(e=this.useCameraPostProcesses),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight()),!this.is2DArray&&!this.is3D||this.isMulti)if(this.isCube&&!this.isMulti)for(let s=0;s<6;s++)this._renderToTarget(s,e,t),r.incrementRenderId(),r.resetCachedMaterial();else this._renderToTarget(0,e,t);else for(let s=0;s<this.getRenderLayers();s++)this._renderToTarget(0,e,t,s),r.incrementRenderId(),r.resetCachedMaterial();this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender()}}"_bestReflectionRenderTargetDimension"(e,t){const r=e*t,s=(0,o.Tr)(r+16384/(128+r));return Math.min((0,o.Av)(e),s)}"_bindFrameBuffer"(e=0,t=0){const r=this.getScene();if(!r)return;const s=r.getEngine();this._renderTarget&&s.bindFramebuffer(this._renderTarget,this.isCube?e:void 0,void 0,void 0,this.ignoreCameraViewport,0,t)}"_unbindFrameBuffer"(e,t){this._renderTarget&&e.unBindFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(t)})}"_prepareFrame"(e,t,r,s){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):s&&e.postProcessManager._prepareFrame(this._texture)||this._bindFrameBuffer(t,r)}"_renderToTarget"(e,t,r,s=0){const i=this.getScene();if(!i)return;const n=i.getEngine();this._currentFaceIndex=e,this._currentLayer=s,this._currentUseCameraPostProcess=t,this._currentDumpForDebug=r,this._prepareFrame(i,e,s,t),n._debugPushGroup?.(`render to face #${e} layer #${s}`,2),this._objectRenderer.render(e+s,!0),n._debugPopGroup?.(2),this._unbindFrameBuffer(n,e),this._texture&&this.isCube&&5===e&&n.generateMipMapsForCubemap(this._texture,!0)}"setRenderingOrder"(e,t=null,r=null,s=null){this._objectRenderer.setRenderingOrder(e,t,r,s)}"setRenderingAutoClearDepthStencil"(e,t){this._objectRenderer.setRenderingAutoClearDepthStencil(e,t)}"clone"(){const e=this.getSize(),t=new RenderTargetTexture(this.name,e,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,this.renderList&&(t.renderList=this.renderList.slice(0)),t}"serialize"(){if(!this.name)return null;const e=super.serialize();if(e.renderTargetSize=this.getRenderSize(),e.renderList=[],this.renderList)for(let t=0;t<this.renderList.length;t++)e.renderList.push(this.renderList[t].id);return e}"disposeFramebufferObjects"(){this._renderTarget?.dispose(!0)}"releaseInternalTexture"(){this._renderTarget?.releaseTextures(),this._texture=null}"dispose"(){this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._objectRenderer.onBeforeRenderingManagerRenderObservable.remove(this._onBeforeRenderingManagerRenderObserver),this._objectRenderer.onAfterRenderingManagerRenderObservable.remove(this._onAfterRenderingManagerRenderObserver),this._objectRenderer.onFastPathRenderObservable.remove(this._onFastPathRenderObserver),this._dontDisposeObjectRenderer||this._objectRenderer.dispose(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null);const e=this.getScene();if(!e)return;let t=e.customRenderTargets.indexOf(this);t>=0&&e.customRenderTargets.splice(t,1);for(const r of e.cameras)t=r.customRenderTargets.indexOf(this),t>=0&&r.customRenderTargets.splice(t,1);this._renderTarget?.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}"_rebuild"(){this._objectRenderer._rebuild(),this._postProcessManager&&this._postProcessManager._rebuild()}"freeRenderingGroups"(){this._objectRenderer.freeRenderingGroups()}"getViewCount"(){return 1}}RenderTargetTexture.REFRESHRATE_RENDER_ONCE=ObjectRenderer.REFRESHRATE_RENDER_ONCE,RenderTargetTexture.REFRESHRATE_RENDER_ONEVERYFRAME=ObjectRenderer.REFRESHRATE_RENDER_ONEVERYFRAME,RenderTargetTexture.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=ObjectRenderer.REFRESHRATE_RENDER_ONEVERYTWOFRAMES,s.x._CreateRenderTargetTexture=(e,t,r,s,i)=>new RenderTargetTexture(e,t,r,s);var u=r(179),p=r(6512),f=r(1890),_=r(5110),g=r(2760),m=r(8948),b=r(2017);class ThinPassPostProcess extends m.H{"_gatherImports"(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([r.e(474).then(r.bind(r,3474))]))):t.push(Promise.all([r.e(675).then(r.bind(r,6675))])),super._gatherImports(e,t)}"constructor"(e,t=null,r){super({...r,"name":e,"engine":t||b.D.LastCreatedEngine,"useShaderStore":!0,"useAsPostProcess":!0,"fragmentShader":ThinPassPostProcess.FragmentUrl})}}ThinPassPostProcess.FragmentUrl="pass";class ThinPassCubePostProcess extends m.H{"_gatherImports"(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([r.e(274).then(r.bind(r,7274))]))):t.push(Promise.all([r.e(43).then(r.bind(r,8043))])),super._gatherImports(e,t)}"constructor"(e,t=null,r){super({...r,"name":e,"engine":t||b.D.LastCreatedEngine,"useShaderStore":!0,"useAsPostProcess":!0,"fragmentShader":ThinPassCubePostProcess.FragmentUrl,"defines":"#define POSITIVEX"}),this._face=0}get"face"(){return this._face}set"face"(e){if(!(e<0||e>5))switch(this._face=e,this._face){case 0:this.updateEffect("#define POSITIVEX");break;case 1:this.updateEffect("#define NEGATIVEX");break;case 2:this.updateEffect("#define POSITIVEY");break;case 3:this.updateEffect("#define NEGATIVEY");break;case 4:this.updateEffect("#define POSITIVEZ");break;case 5:this.updateEffect("#define NEGATIVEZ")}}}ThinPassCubePostProcess.FragmentUrl="passCube";var R=r(3238);class PassPostProcess extends p.D{"getClassName"(){return"PassPostProcess"}"constructor"(e,t,r=null,s,i,n,a=0,o=!1){const h={"size":"number"==typeof t?t:void 0,"camera":r,"samplingMode":s,"engine":i,"reusable":n,"textureType":a,"blockCompilation":o,...t};super(e,ThinPassPostProcess.FragmentUrl,{"effectWrapper":"number"!=typeof t&&t.effectWrapper?void 0:new ThinPassPostProcess(e,i,h),...h})}static"_Parse"(e,t,r,s){return g.p.Parse(()=>new PassPostProcess(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable),e,r,s)}}(0,_.H7)("BABYLON.PassPostProcess",PassPostProcess);class PassCubePostProcess extends p.D{get"face"(){return this._effectWrapper.face}set"face"(e){this._effectWrapper.face=e}"getClassName"(){return"PassCubePostProcess"}"constructor"(e,t,r=null,s,i,n,a=0,o=!1){const h={"size":"number"==typeof t?t:void 0,"camera":r,"samplingMode":s,"engine":i,"reusable":n,"textureType":a,"blockCompilation":o,...t};super(e,ThinPassPostProcess.FragmentUrl,{"effectWrapper":"number"!=typeof t&&t.effectWrapper?void 0:new ThinPassCubePostProcess(e,i,h),...h})}static"_Parse"(e,t,r,s){return g.p.Parse(()=>new PassCubePostProcess(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable),e,r,s)}}function ApplyPostProcess(e,t,r,s,i,n,a,o){const h=t.getEngine();return t.isReady=!1,i=i??t.samplingMode,s=s??t.type,n=n??t.format,a=a??t.width,o=o??t.height,-1===s&&(s=0),new Promise(d=>{const c=new p.D("postprocess",e,null,null,1,null,i,h,!1,void 0,s,void 0,null,!1,n);c.externalTextureSamplerBinding=!0;const l=h.createRenderTargetTexture({"width":a,"height":o},{"generateDepthBuffer":!1,"generateMipMaps":!1,"generateStencilBuffer":!1,"samplingMode":i,"type":s,"format":n});c.onEffectCreatedObservable.addOnce(e=>{e.executeWhenCompiled(()=>{c.onApply=e=>{e._bindTexture("textureSampler",t),e.setFloat2("scale",1,1)},r.postProcessManager.directRender([c],l,!0),h.restoreDefaultFramebuffer(),h._releaseTexture(t),c&&c.dispose(),l._swapAndDie(t),t.type=s,t.format=5,t.isReady=!0,d(t)})})})}let P,v;function ToHalfFloat(e){P||(P=new Float32Array(1),v=new Int32Array(P.buffer)),P[0]=e;const t=v[0];let r=t>>16&32768,s=t>>12&2047;const i=t>>23&255;return i<103?r:i>142?(r|=31744,r|=(255==i?0:1)&&8388607&t,r):i<113?(s|=2048,r|=(s>>114-i)+(s>>113-i&1),r):(r|=i-112<<10|s>>1,r+=1&s,r)}function FromHalfFloat(e){const t=(32768&e)>>15,r=(31744&e)>>10,s=1023&e;return 0===r?(t?-1:1)*Math.pow(2,-14)*(s/Math.pow(2,10)):31==r?s?NaN:1/0*(t?-1:1):(t?-1:1)*Math.pow(2,r-15)*(1+s/Math.pow(2,10))}(0,u.gn)([(0,R.qC)()],PassCubePostProcess.prototype,"face",null),f.a._RescalePostProcessFactory=e=>new PassPostProcess("rescale",1,null,2,e,!1,0)},"6512":function(e,t,r){r.d(t,{"D":function(){return PostProcess}});var s=r(179),i=r(8860),n=r(5081),a=r(3242),o=r(3222),h=r(3238),d=r(2760),c=r(5110),l=r(1890),u=r(6313),p=r(8948);l.a.prototype.setTextureFromPostProcess=function(e,t,r){let s=null;t&&(t._forcedOutputTexture?s=t._forcedOutputTexture:t._textures.data[t._currentRenderTextureInd]&&(s=t._textures.data[t._currentRenderTextureInd])),this._bindTexture(e,s?.texture??null,r)},l.a.prototype.setTextureFromPostProcessOutput=function(e,t,r){this._bindTexture(e,t?._outputTexture?.texture??null,r)},o.Q.prototype.setTextureFromPostProcess=function(e,t){this._engine.setTextureFromPostProcess(this._samplers[e],t,e)},o.Q.prototype.setTextureFromPostProcessOutput=function(e,t){this._engine.setTextureFromPostProcessOutput(this._samplers[e],t,e)};class PostProcess{static get"ForceGLSL"(){return p.H.ForceGLSL}static set"ForceGLSL"(e){p.H.ForceGLSL=e}static"RegisterShaderCodeProcessing"(e,t){p.H.RegisterShaderCodeProcessing(e,t)}get"name"(){return this._effectWrapper.name}set"name"(e){this._effectWrapper.name=e}get"alphaMode"(){return this._effectWrapper.alphaMode}set"alphaMode"(e){this._effectWrapper.alphaMode=e}get"samples"(){return this._samples}set"samples"(e){this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach(e=>{e.setSamples(this._samples)})}get"shaderLanguage"(){return this._shaderLanguage}"getEffectName"(){return this._fragmentUrl}set"onActivate"(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))}set"onSizeChanged"(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)}set"onApply"(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)}set"onBeforeRender"(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set"onAfterRender"(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get"inputTexture"(){return this._textures.data[this._currentRenderTextureInd]}set"inputTexture"(e){this._forcedOutputTexture=e}"restoreDefaultInputTexture"(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}"getCamera"(){return this._camera}get"texelSize"(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}"constructor"(e,t,r,s,o,h,d=1,c,l,u=null,f=0,_="postprocess",g,m=!1,b=5,R,P){this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.forceAutoClearInAlphaMode=!1,this.animations=[],this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._webGPUReady=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new i.t(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new a.FM(1,1),this._texelSize=a.FM.Zero(),this.onActivateObservable=new n.y$,this.onSizeChangedObservable=new n.y$,this.onApplyObservable=new n.y$,this.onBeforeRenderObservable=new n.y$,this.onAfterRenderObservable=new n.y$,this.onDisposeObservable=new n.y$;let v,x=1,T=null;if(r&&!Array.isArray(r)){const e=r;r=e.uniforms??null,s=e.samplers??null,x=e.size??1,h=e.camera??null,d=e.samplingMode??1,c=e.engine,l=e.reusable,u=Array.isArray(e.defines)?e.defines.join("\n"):e.defines??null,f=e.textureType??0,_=e.vertexUrl??"postprocess",g=e.indexParameters,m=e.blockCompilation??!1,b=e.textureFormat??5,R=e.shaderLanguage??0,T=e.uniformBuffers??null,P=e.extraInitializations,v=e.effectWrapper}else o&&(x="number"==typeof o?o:{"width":o.width,"height":o.height});if(this._useExistingThinPostProcess=!!v,this._effectWrapper=v??new p.H({"name":e,"useShaderStore":!0,"useAsPostProcess":!0,"fragmentShader":t,"engine":c||h?.getScene().getEngine(),"uniforms":r,"samplers":s,"uniformBuffers":T,"defines":u,"vertexUrl":_,"indexParameters":g,"blockCompilation":!0,"shaderLanguage":R,"extraInitializations":void 0}),this.name=e,this.onEffectCreatedObservable=this._effectWrapper.onEffectCreatedObservable,null!=h?(this._camera=h,this._scene=h.getScene(),h.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):c&&(this._engine=c,this._engine.postProcesses.push(this)),this._options=x,this.renderTargetSamplingMode=d||1,this._reusable=l||!1,this._textureType=f,this._textureFormat=b,this._shaderLanguage=R||0,this._samplers=s||[],-1===this._samplers.indexOf("textureSampler")&&this._samplers.push("textureSampler"),this._fragmentUrl=t,this._vertexUrl=_,this._parameters=r||[],-1===this._parameters.indexOf("scale")&&this._parameters.push("scale"),this._uniformBuffers=T||[],this._indexParameters=g,!this._useExistingThinPostProcess){this._webGPUReady=1===this._shaderLanguage;const e=[];this._gatherImports(this._engine.isWebGPU&&!PostProcess.ForceGLSL,e),this._effectWrapper._webGPUReady=this._webGPUReady,this._effectWrapper._postConstructor(m,u,P,e)}}"_gatherImports"(e=!1,t){e&&this._webGPUReady?t.push(Promise.all([r.e(771).then(r.bind(r,6771))])):t.push(Promise.all([Promise.resolve().then(r.bind(r,2433))]))}"getClassName"(){return"PostProcess"}"getEngine"(){return this._engine}"getEffect"(){return this._effectWrapper.drawWrapper.effect}"shareOutputWith"(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this}"useOwnOutput"(){0==this._textures.length&&(this._textures=new i.t(2)),this._shareOutputWithPostProcess=null}"updateEffect"(e=null,t=null,r=null,s,i,n,a,o){this._effectWrapper.updateEffect(e,t,r,s,i,n,a,o),this._postProcessDefines=Array.isArray(this._effectWrapper.options.defines)?this._effectWrapper.options.defines.join("\n"):this._effectWrapper.options.defines}"isReusable"(){return this._reusable}"markTextureDirty"(){this.width=-1}"_createRenderTargetTexture"(e,t,r=0){for(let s=0;s<this._textureCache.length;s++)if(this._textureCache[s].texture.width===e.width&&this._textureCache[s].texture.height===e.height&&this._textureCache[s].postProcessChannel===r&&this._textureCache[s].texture._generateDepthBuffer===t.generateDepthBuffer&&this._textureCache[s].texture.samples===t.samples)return this._textureCache[s].texture;const s=this._engine.createRenderTargetTexture(e,t);return this._textureCache.push({"texture":s,"postProcessChannel":r,"lastUsedRenderId":-1}),s}"_flushTextureCache"(){const e=this._renderId;for(let t=this._textureCache.length-1;t>=0;t--)if(e-this._textureCache[t].lastUsedRenderId>100){let e=!1;for(let r=0;r<this._textures.length;r++)if(this._textures.data[r]===this._textureCache[t].texture){e=!0;break}e||(this._textureCache[t].texture.dispose(),this._textureCache.splice(t,1))}}"resize"(e,t,r=null,s=!1,i=!1){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=t;let n=null;if(r)for(let e=0;e<r._postProcesses.length;e++)if(null!==r._postProcesses[e]){n=r._postProcesses[e];break}const a={"width":this.width,"height":this.height},o={"generateMipMaps":s,"generateDepthBuffer":i||n===this,"generateStencilBuffer":(i||n===this)&&this._engine.isStencilEnable,"samplingMode":this.renderTargetSamplingMode,"type":this._textureType,"format":this._textureFormat,"samples":this._samples,"label":"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(a,o,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(a,o,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}"_getTarget"(){let e;if(this._shareOutputWithPostProcess)e=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)e=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{let t;e=this.inputTexture;for(let r=0;r<this._textureCache.length;r++)if(this._textureCache[r].texture===e){t=this._textureCache[r];break}t&&(t.lastUsedRenderId=this._renderId)}return e}"activate"(e,t=null,r){const s=null===e||void 0!==e.cameraRigMode?e||this._camera:null,i=s?.getScene()??e,n=i.getEngine(),a=n.getCaps().maxTextureSize,o=(t?t.width:this._engine.getRenderWidth(!0))*this._options|0,h=(t?t.height:this._engine.getRenderHeight(!0))*this._options|0;let d=this._options.width||o,c=this._options.height||h;const l=7!==this.renderTargetSamplingMode&&1!==this.renderTargetSamplingMode&&2!==this.renderTargetSamplingMode;let p=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const e=n.currentViewport;e&&(d*=e.width,c*=e.height)}(l||this.alwaysForcePOT)&&(this._options.width||(d=n.needPOTTextures?(0,u.p7)(d,a,this.scaleMode):d),this._options.height||(c=n.needPOTTextures?(0,u.p7)(c,a,this.scaleMode):c)),this.width===d&&this.height===c&&(p=this._getTarget())||this.resize(d,c,s,l,r),this._textures.forEach(e=>{e.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(e,this.samples)}),this._flushTextureCache(),this._renderId++}return p||(p=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(o/d,h/c),this._engine.bindFramebuffer(p,0,o,h,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(p,0,void 0,void 0,this.forceFullscreenViewport)),this._engine._debugInsertMarker?.(`post process ${this.name} input`),this.onActivateObservable.notifyObservers(s),this.autoClear&&(0===this.alphaMode||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:i.clearColor,i._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),p}get"isSupported"(){return this._effectWrapper.drawWrapper.effect.isSupported}get"aspectRatio"(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}"isReady"(){return this._effectWrapper.isReady()}"apply"(){if(!this._effectWrapper.isReady())return null;let e;return this._engine.enableEffect(this._effectWrapper.drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),e=this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?this._forcedOutputTexture:this.inputTexture,this.externalTextureSamplerBinding||this._effectWrapper.drawWrapper.effect._bindTexture("textureSampler",e?.texture),this._effectWrapper.drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effectWrapper.drawWrapper.effect),this._effectWrapper.bind(),this._effectWrapper.drawWrapper.effect}"_disposeTextures"(){this._shareOutputWithPostProcess||this._forcedOutputTexture?this._disposeTextureCache():(this._disposeTextureCache(),this._textures.dispose())}"_disposeTextureCache"(){for(let e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0}"setPrePassRenderer"(e){return!!this._prePassEffectConfiguration&&(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0)}"dispose"(e){let t;if(e=e||this._camera,this._useExistingThinPostProcess||this._effectWrapper.dispose(),this._disposeTextures(),this._scene&&(t=this._scene.postProcesses.indexOf(this),-1!==t&&this._scene.postProcesses.splice(t,1)),this._parentContainer){const e=this._parentContainer.postProcesses.indexOf(this);e>-1&&this._parentContainer.postProcesses.splice(e,1),this._parentContainer=null}if(t=this._engine.postProcesses.indexOf(this),-1!==t&&this._engine.postProcesses.splice(t,1),this.onDisposeObservable.notifyObservers(),e){if(e.detachPostProcess(this),t=e._postProcesses.indexOf(this),0===t&&e._postProcesses.length>0){const e=this._camera._getFirstPostProcess();e&&e.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear(),this.onEffectCreatedObservable.clear()}}"serialize"(){const e=d.p.Serialize(this),t=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=t?t.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.uniformBuffers=this._uniformBuffers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e}"clone"(){const e=this.serialize();e._engine=this._engine,e.cameraId=null;const t=PostProcess.Parse(e,this._scene,"");return t?(t.onActivateObservable=this.onActivateObservable.clone(),t.onSizeChangedObservable=this.onSizeChangedObservable.clone(),t.onApplyObservable=this.onApplyObservable.clone(),t.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),t.onAfterRenderObservable=this.onAfterRenderObservable.clone(),t._prePassEffectConfiguration=this._prePassEffectConfiguration,t):null}static"Parse"(e,t,r){const s=(0,c.qw)(e.customType);if(!s||!s._Parse)return null;const i=t?t.getCameraById(e.cameraId):null;return s._Parse(e,i,t,r)}static"_Parse"(e,t,r,s){return d.p.Parse(()=>new PostProcess(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,!1,e.textureFormat),e,r,s)}}(0,s.gn)([(0,h.qC)()],PostProcess.prototype,"uniqueId",void 0),(0,s.gn)([(0,h.qC)()],PostProcess.prototype,"name",null),(0,s.gn)([(0,h.qC)()],PostProcess.prototype,"width",void 0),(0,s.gn)([(0,h.qC)()],PostProcess.prototype,"height",void 0),(0,s.gn)([(0,h.qC)()],PostProcess.prototype,"renderTargetSamplingMode",void 0),(0,s.gn)([(0,h.XX)()],PostProcess.prototype,"clearColor",void 0),(0,s.gn)([(0,h.qC)()],PostProcess.prototype,"autoClear",void 0),(0,s.gn)([(0,h.qC)()],PostProcess.prototype,"forceAutoClearInAlphaMode",void 0),(0,s.gn)([(0,h.qC)()],PostProcess.prototype,"alphaMode",null),(0,s.gn)([(0,h.qC)()],PostProcess.prototype,"alphaConstants",void 0),(0,s.gn)([(0,h.qC)()],PostProcess.prototype,"enablePixelPerfectMode",void 0),(0,s.gn)([(0,h.qC)()],PostProcess.prototype,"forceFullscreenViewport",void 0),(0,s.gn)([(0,h.qC)()],PostProcess.prototype,"scaleMode",void 0),(0,s.gn)([(0,h.qC)()],PostProcess.prototype,"alwaysForcePOT",void 0),(0,s.gn)([(0,h.qC)("samples")],PostProcess.prototype,"_samples",void 0),(0,s.gn)([(0,h.qC)()],PostProcess.prototype,"adaptScaleToCurrentViewport",void 0),(0,c.H7)("BABYLON.PostProcess",PostProcess)},"2433":function(e,t,r){r.r(t),r.d(t,{"postprocessVertexShader":function(){return a}});var s=r(6104);const i="postprocessVertexShader",n="attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);\n#define CUSTOM_VERTEX_MAIN_END\n}";s.v.ShadersStore[i]||(s.v.ShadersStore[i]=n);const a={"name":i,"shader":n}}}]);