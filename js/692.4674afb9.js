"use strict";(self.webpackJsonp=self.webpackJsonp||[]).push([[692],{"3692":function(e,t,a){a.r(t),a.d(t,{"_BasisTextureLoader":function(){return _BasisTextureLoader}});var s,r=a(9142),o=a(4639),n=a(5341);function workerFunction(){const e=0,t=1,a=2,s=3,r=6,o=8,n=9,i=10,c=14;let l=null;function TranscodeLevel(e,t,a,s,r){const o=e.getImageTranscodedSizeInBytes(t,a,s);let n=new Uint8Array(o);if(!e.transcodeImage(n,t,a,s,1,0))return null;if(r){n=function ConvertDxtToRgb565(e,t,a,s){const r=new Uint16Array(4),o=new Uint16Array(a*s),n=a/4,i=s/4;for(let s=0;s<i;s++)for(let i=0;i<n;i++){const c=t+8*(s*n+i);r[0]=e[c]|e[c+1]<<8,r[1]=e[c+2]|e[c+3]<<8,r[2]=(2*(31&r[0])+1*(31&r[1]))/3|(2*(2016&r[0])+1*(2016&r[1]))/3&2016|(2*(63488&r[0])+1*(63488&r[1]))/3&63488,r[3]=(2*(31&r[1])+1*(31&r[0]))/3|(2*(2016&r[1])+1*(2016&r[0]))/3&2016|(2*(63488&r[1])+1*(63488&r[0]))/3&63488;for(let t=0;t<4;t++){const n=e[c+4+t];let l=(4*s+t)*a+4*i;o[l++]=r[3&n],o[l++]=r[n>>2&3],o[l++]=r[n>>4&3],o[l++]=r[n>>6&3]}}return o}(n,0,e.getImageWidth(t,a)+3&-4,e.getImageHeight(t,a)+3&-4)}return n}onmessage=d=>{if("init"===d.data.action){if(d.data.url)try{importScripts(d.data.url)}catch(e){postMessage({"action":"error","error":e})}l||(l=BASIS({"wasmBinary":d.data.wasmBinary})),null!==l&&l.then(e=>{BASIS=e,e.initializeBasis(),postMessage({"action":"init"})})}else if("transcode"===d.data.action){const l=d.data.config,u=d.data.imageData,T=new BASIS.BasisFile(u),p=function GetFileInfo(e){const t=e.getHasAlpha(),a=e.getNumImages(),s=[];for(let t=0;t<a;t++){const a={"levels":[]},r=e.getNumLevels(t);for(let s=0;s<r;s++){const r={"width":e.getImageWidth(t,s),"height":e.getImageHeight(t,s)};a.levels.push(r)}s.push(a)}return{"hasAlpha":t,"images":s}}(T);let g=d.data.ignoreSupportedFormats?null:function GetSupportedTranscodeFormat(l,d){let u=null;l.supportedCompressionFormats&&(u=l.supportedCompressionFormats.astc?i:l.supportedCompressionFormats.bc7?r:l.supportedCompressionFormats.s3tc?d.hasAlpha?s:a:l.supportedCompressionFormats.pvrtc?d.hasAlpha?n:o:l.supportedCompressionFormats.etc2?t:l.supportedCompressionFormats.etc1?e:c);return u}(d.data.config,p),f=!1;null===g&&(f=!0,g=p.hasAlpha?s:a);let m=!0;T.startTranscoding()||(m=!1);const h=[];for(let e=0;e<p.images.length&&m;e++){const t=p.images[e];if(void 0===l.loadSingleImage||l.loadSingleImage===e){let a=t.levels.length;!1===l.loadMipmapLevels&&(a=1);for(let s=0;s<a;s++){const a=t.levels[s],r=TranscodeLevel(T,e,s,g,f);if(!r){m=!1;break}a.transcodedPixels=r,h.push(a.transcodedPixels.buffer)}}}T.close(),T.delete(),f&&(g=-1),m?postMessage({"action":"transcode","success":m,"id":d.data.id,"fileInfo":p,"format":g},h):postMessage({"action":"transcode","success":m,"id":d.data.id})}}}!function(e){e[e.cTFETC1=0]="cTFETC1",e[e.cTFETC2=1]="cTFETC2",e[e.cTFBC1=2]="cTFBC1",e[e.cTFBC3=3]="cTFBC3",e[e.cTFBC4=4]="cTFBC4",e[e.cTFBC5=5]="cTFBC5",e[e.cTFBC7=6]="cTFBC7",e[e.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",e[e.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",e[e.cTFASTC_4x4=10]="cTFASTC_4x4",e[e.cTFATC_RGB=11]="cTFATC_RGB",e[e.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",e[e.cTFRGBA32=13]="cTFRGBA32",e[e.cTFRGB565=14]="cTFRGB565",e[e.cTFBGR565=15]="cTFBGR565",e[e.cTFRGBA4444=16]="cTFRGBA4444",e[e.cTFFXT1_RGB=17]="cTFFXT1_RGB",e[e.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",e[e.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",e[e.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",e[e.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(s||(s={}));const i={"JSModuleURL":`${r.w1._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,"WasmModuleURL":`${r.w1._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let c=null,l=null,d=0;const _CreateWorkerAsync=()=>(c||(c=new Promise((e,t)=>{l?e(l):r.w1.LoadFileAsync(r.w1.GetBabylonScriptURL(i.WasmModuleURL)).then(a=>{if("function"!=typeof URL)return t("Basis transcoder requires an environment with a URL constructor");const s=URL.createObjectURL(new Blob([`(${workerFunction})()`],{"type":"application/javascript"}));l=new Worker(s),function initializeWebWorker(e,t,a){return new Promise((s,o)=>{const initHandler=t=>{"init"===t.data.action?(e.removeEventListener("message",initHandler),s(e)):"error"===t.data.action&&o(t.data.error||"error initializing worker")};e.addEventListener("message",initHandler),e.postMessage({"action":"init","url":a?r.w1.GetBabylonScriptURL(a):void 0,"wasmBinary":t},[t])})}(l,a,i.JSModuleURL).then(e,t)}).catch(t)})),c),TranscodeAsync=(e,t)=>{const a=e instanceof ArrayBuffer?new Uint8Array(e):e;return new Promise((e,s)=>{_CreateWorkerAsync().then(()=>{const r=d++,messageHandler=t=>{"transcode"===t.data.action&&t.data.id===r&&(l.removeEventListener("message",messageHandler),t.data.success?e(t.data):s("Transcode is not supported on this device"))};l.addEventListener("message",messageHandler);const o=new Uint8Array(a.byteLength);o.set(new Uint8Array(a.buffer,a.byteOffset,a.byteLength)),l.postMessage({"action":"transcode","id":r,"imageData":o,"config":t,"ignoreSupportedFormats":false},[o.buffer])},e=>{s(e)})})},BindTexture=(e,t)=>{let a=t._gl?.TEXTURE_2D;e.isCube&&(a=t._gl?.TEXTURE_CUBE_MAP),t._bindTextureDirectly(a,e,!0)},LoadTextureFromTranscodeResult=(e,t)=>{const a=e.getEngine();for(let i=0;i<t.fileInfo.images.length;i++){const c=t.fileInfo.images[i].levels[0];if(e._invertVScale=e.invertY,-1===t.format||t.format===s.cTFRGB565)if(e.type=10,e.format=4,!a._features.basisNeedsPOT||Math.log2(c.width)%1==0&&Math.log2(c.height)%1==0)e._invertVScale=!e.invertY,e.width=c.width+3&-4,e.height=c.height+3&-4,e.samplingMode=2,BindTexture(e,a),a._uploadDataToTextureDirectly(e,new Uint16Array(c.transcodedPixels.buffer),i,0,4,!0);else{const t=new n.l(a,2);e._invertVScale=e.invertY,t.type=10,t.format=4,t.width=c.width+3&-4,t.height=c.height+3&-4,BindTexture(t,a),a._uploadDataToTextureDirectly(t,new Uint16Array(c.transcodedPixels.buffer),i,0,4,!0),a._rescaleTexture(t,e,a.scenes[0],a._getInternalFormat(4),()=>{a._releaseTexture(t),BindTexture(e,a)})}else{e.width=c.width,e.height=c.height,e.generateMipMaps=t.fileInfo.images[i].levels.length>1;const s=u.GetInternalFormatFromBasisFormat(t.format,a);e.format=s,BindTexture(e,a),t.fileInfo.images[i].levels.forEach((t,r)=>{a._uploadCompressedDataToTextureDirectly(e,s,t.width,t.height,t.transcodedPixels,i,r)}),!a._features.basisNeedsPOT||Math.log2(e.width)%1==0&&Math.log2(e.height)%1==0||(r.w1.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),e._cachedWrapU=o.x.CLAMP_ADDRESSMODE,e._cachedWrapV=o.x.CLAMP_ADDRESSMODE)}}},u={"JSModuleURL":i.JSModuleURL,"WasmModuleURL":i.WasmModuleURL,"GetInternalFormatFromBasisFormat":(e,t)=>{let a;switch(e){case s.cTFETC1:a=36196;break;case s.cTFBC1:a=33776;break;case s.cTFBC4:a=33779;break;case s.cTFASTC_4x4:a=37808;break;case s.cTFETC2:a=37496;break;case s.cTFBC7:a=36492}if(void 0===a)throw"The chosen Basis transcoder format is not currently supported";return a},"TranscodeAsync":TranscodeAsync,"LoadTextureFromTranscodeResult":LoadTextureFromTranscodeResult};Object.defineProperty(u,"JSModuleURL",{"get":function(){return i.JSModuleURL},"set":function(e){i.JSModuleURL=e}}),Object.defineProperty(u,"WasmModuleURL",{"get":function(){return i.WasmModuleURL},"set":function(e){i.WasmModuleURL=e}});class _BasisTextureLoader{"constructor"(){this.supportCascades=!1}"loadCubeData"(e,t,a,s,o){if(Array.isArray(e))return;const n=t.getEngine().getCaps(),i={"supportedCompressionFormats":{"etc1":!!n.etc1,"s3tc":!!n.s3tc,"pvrtc":!!n.pvrtc,"etc2":!!n.etc2,"astc":!!n.astc,"bc7":!!n.bptc}};TranscodeAsync(e,i).then(e=>{const a=e.fileInfo.images[0].levels.length>1&&t.generateMipMaps;LoadTextureFromTranscodeResult(t,e),t.getEngine()._setCubeMapTextureParams(t,a),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s()}).catch(e=>{r.w1.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),t.isReady=!0,o&&o(e)})}"loadData"(e,t,a){const s=t.getEngine().getCaps(),o={"supportedCompressionFormats":{"etc1":!!s.etc1,"s3tc":!!s.s3tc,"pvrtc":!!s.pvrtc,"etc2":!!s.etc2,"astc":!!s.astc,"bc7":!!s.bptc}};TranscodeAsync(e,o).then(e=>{const s=e.fileInfo.images[0].levels[0],r=e.fileInfo.images[0].levels.length>1&&t.generateMipMaps;a(s.width,s.height,r,-1!==e.format,()=>{LoadTextureFromTranscodeResult(t,e)})}).catch(e=>{r.w1.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),r.w1.Warn(`Failed to transcode Basis file: ${e}`),a(0,0,!1,!1,()=>{},!0)})}}}}]);