---
projects:
  - "[[AMIO]]"
tags:
  - cc
---

# 鲨之星3D虚拟世界 MVP开发计划

## V1.0

> **“一个人的星球，也值得被建造。”**
> 
> AMIO · Keep Us Human

---

# 1. MVP 目标

## 1.1 核心假设

**“用户愿意通过与AI对话来参与虚拟星球建设，并因为在星球上留下永久印记而产生情感连接。”**

MVP 只需验证这一件事。不需要完美的画面、完整的世界、也不需要多人同步。

## 1.2 MVP 体验链路

```markdown
用户打开链接
  → 进入3D世界，看到AI机器人在自主建造
  → 走到机器人旁边，点击它
  → 和机器人对话："帮我在这里建一座纪念碑，叫做四块钱球拍纪念碑"
  → 机器人回复后走到空地开始建造
  → 建造完成，点击建筑能看到自己的名字
  → 关闭页面，下次打开，建筑还在
```

这条链路跑通，MVP 就成功了。

## 1.3 设计约束

| 约束项 | 说明 |
|--------|------|
| 用户模式 | **单用户** + 5-10个AI Agent |
| 目标平台 | **仅H5**（移动端浏览器优先） |
| 团队规模 | 2人（开发 + 设计） |
| 开发周期 | **8周** |

---

# 2. MVP 范围定义

## 2.1 保留的功能

| 功能 | 说明 |
|------|------|
| 3D场景行走 | 用户操控角色在小型场景中自由移动 |
| AI Agent自主行为 | 5-10个Builder机器人自主巡逻和建造 |
| 与AI对话建造 | 用户和机器人自然语言对话，指挥建造/命名建筑 |
| 建筑信息查看 | 点击建筑显示名称、建造者、时间 |
| 世界持久化 | 建筑数据保存到数据库，下次登录恢复 |

## 2.2 砍掉的功能

| 砍掉的功能 | 理由 |
|-----------|------|
| 多用户同步 / Socket.IO | MVP先验证单用户体验，多人同步是后续叠加 |
| 服务器权威架构 | 单用户无需防作弊/状态仲裁 |
| 实时聊天 | 没有其他用户 |
| 微信小程序端 | MVP只做H5 |
| 探索型机器人（Explorer） | 只保留建造型Builder |
| 星球进度系统 | 世界已存在，不需要从0%开始 |
| LOD / 空间分区 | 单用户场景小，不需要优化 |
| 复杂寻路（A*） | 简单直线移动+绕障即可 |

---

# 3. MVP 架构

## 3.1 架构图

```markdown
┌──────────────────────────────────────────────────┐
│                  客户端 (浏览器)                    │
│                                                  │
│  Babylon.js 3D渲染                                │
│  ┌──────────────┐  ┌─────────────────────────┐    │
│  │ 世界状态(本地) │  │ AI Agent管理器           │    │
│  │ 建筑/Agent/   │  │ 行为树tick              │    │
│  │ 玩家位置      │  │ 5-10个Agent本地运行      │    │
│  └──────────────┘  └─────────────────────────┘    │
│                                                  │
│  ┌──────────────────────────────────────────┐     │
│  │ UI层：对话框 / 建筑信息面板               │     │
│  └──────────────────────────────────────────┘     │
└─────────────────────┬────────────────────────────┘
                      │ HTTP/REST (仅对话和持久化)
                      │
         ┌────────────┴────────────┐
         │    轻量后端 (Node.js)     │
         │                         │
         │  POST /api/chat → LLM   │
         │  POST /api/save-world   │
         │  GET  /api/load-world   │
         └────────────┬────────────┘
                      │
              ┌───────┴───────┐
              │   MongoDB     │
              │   LLM API     │
              └───────────────┘
```

## 3.2 与完整版架构的关系

MVP 的架构是完整版的子集，升级路径清晰：

| MVP（单用户） | 完整版（多用户） | 升级方式 |
|-------------|--------------|---------|
| 世界状态在前端内存 | 世界状态在服务器内存 | 将前端WorldState迁移到服务端 |
| 行为树在前端运行 | 行为树在服务端运行 | 行为树代码本身不变，只换运行环境 |
| HTTP REST调用 | WebSocket长连接 | 加入Socket.IO，通信协议已在技术文档中定义 |
| 无需同步 | 增量广播+空间过滤 | 新增广播层 |

## 3.3 技术栈

| 组件 | 选型 | 说明 |
|------|------|------|
| 前端3D | Babylon.js + TypeScript | 与完整版一致 |
| 前端构建 | Vite | 快速HMR，TypeScript原生支持 |
| 前端UI | React（对话框/面板） | 可复用到完整版 |
| 后端 | Node.js + Express + TypeScript | 3个API接口，极简 |
| AI对话 | DeepSeek / 通义千问 | 与完整版一致 |
| 数据库 | MongoDB | 与完整版一致 |
| 3D资产 | glTF 2.0 | 与完整版一致 |

---

# 4. Sprint 计划

## Sprint 1（第 1-2 周）：3D 场景 + 角色行走

### 目标

浏览器打开就能进入3D世界，操控角色四处走动。

### 任务清单

**项目搭建**

- Babylon.js + TypeScript + Vite 项目初始化
- 目录结构规划（scene / agents / ui / api）
- 基础资产加载流程

**场景构建**

- 一块平坦地形（低多边形风格，约200m × 200m）
- 天空盒（卡通风格星空/日景）
- 基础光照（平行光 + 环境光）
- 简单地面纹理

**角色与控制**

- 玩家角色渲染（胶囊体/简单几何体占位）
- 第三人称摄像机（跟随 + 鼠标/触摸旋转缩放）
- 移动端虚拟摇杆（屏幕左下角）
- 桌面端 WASD 键盘控制
- 角色碰撞检测（不穿地/不穿墙）

### 验收标准

> 手机浏览器打开页面，看到3D场景，用摇杆控制角色行走，摄像机平滑跟随。

---

## Sprint 2（第 3-4 周）：AI Agent 行为系统

### 目标

场景里有AI机器人在自主活动和建造。

### 任务清单

**行为树框架**

- 4种基础节点实现：Selector / Sequence / Condition / Action
- 节点状态：Running / Success / Failure
- BehaviorTree类：持有根节点，提供tick()方法
- 单元测试覆盖基础节点逻辑

**Builder Agent 行为树**

```markdown
Root (Selector)
├── [有建造任务?] → Sequence
│   ├── 移动到建造点
│   ├── 播放建造动画
│   ├── 每tick推进建造进度
│   └── 进度=100% → 标记完成 → 请求新任务
├── [有巡逻路线?] → Sequence
│   ├── 沿路径点移动
│   └── 到达 → 切换下一个路径点
└── [默认] → 待机动画
```

**Agent 管理器**

- AgentManager 类：统一创建/管理/tick所有Agent
- 5-10个Agent实例，分布在场景不同位置
- tick频率：利用requestAnimationFrame，每帧或每200ms tick一次
- Agent自动领取建造任务（从预设任务池）

**Agent 渲染**

- Agent 3D模型（Q版占位模型，后期替换）
- 头顶名称标签（Babylon.js GUI）
- 头顶状态气泡（“正在建造：xxx 62%”）
- 移动动画（平滑插值到目标位置）

**建筑系统**

- 3-5种预制建筑模型（简单几何体组合）
- 建筑建造视觉效果：
  - 建造中：半透明 + 粒子特效 + 进度条
  - 建造完成：变为实体 + 完成特效（光芒/粒子爆发）
- BuildingManager 类：管理所有建筑的创建/渲染/信息

**世界状态**

- WorldState 类：统一管理玩家/Agent/建筑/星球数据
- 提供序列化/反序列化方法（为后续持久化做准备）

### 验收标准

> 进入3D世界后能看到若干AI机器人在场景中走动，每隔一段时间有机器人走到空地上开始建造，建造过程中显示进度，建造完成后出现一座建筑。

---

## Sprint 3（第 5-6 周）：AI 对话建造

### 目标

跑通“和AI对话 → AI执行建造”的完整链路。**这是MVP的灵魂。**

### 任务清单

**后端API服务**

- Node.js + Express + TypeScript 项目搭建
- 3个API接口：

```markdown
POST /api/chat
  请求：{ agentId, message, worldContext, history }
  处理：构造Prompt → 调用LLM → 解析response
  响应：{ reply, action }

POST /api/save-world
  请求：{ worldState }（序列化的世界状态）
  处理：写入MongoDB
  响应：{ success }

GET /api/load-world
  请求：无
  处理：从MongoDB读取最新世界状态
  响应：{ worldState }
```

- LLM集成（DeepSeek或通义千问 SDK）
- Prompt模板实现

**Prompt 设计**

```markdown
系统Prompt包含：
1. 角色设定（机器人名称、性格、所在区域）
2. 可执行行为白名单（JSON Schema）
   - build: { type, name, near }
   - move_to: { target }
   - change_style: { buildingId, style }
   - none: {}
3. 限制规则（每日建造上限3次、空间限制、禁止操作）
4. 当前世界状态（动态注入）
5. 对话历史（最近8轮）
6. 输出格式（reply + action JSON）
```

**前端对话UI**

- 点击Agent → 判断距离是否足够近
- 弹出对话框（底部弹出式，移动端友好）
- 输入框 + 发送按钮
- 对话气泡（用户消息在右，Agent回复在左）
- “思考中…”动画（Agent头顶显示省略号气泡）
- 关闭对话框按钮

**对话处理流程**

```markdown
用户点击Agent → 打开对话框
用户输入消息 → 发送到后端 /api/chat
  ├── 请求中携带：agentId, message, worldContext, history
  ├── 前端显示"思考中..."
  └── 后端返回 { reply, action }
       ├── 显示Agent回复文本
       └── 如果有action：
           ├── 前端行为校验
           │   ├── 建造频率检查（今日 < 3次）
           │   ├── 空间检测（目标位置无已有建筑）
           │   └── 内容审核（建筑名称无违禁词）
           ├── 校验通过 → 注入Agent任务队列
           └── 校验失败 → 显示Agent的友好拒绝回复
```

**行为校验层**

| 校验项 | 规则 | 失败时Agent回复 |
|--------|------|---------------|
| 行为类型 | 必须在白名单内 | （忽略action，只显示文本） |
| 建造频率 | 今日建造次数 < 3 | “今天的建造次数用完了，明天再来吧~” |
| 空间可用性 | 目标位置无已有建筑 | “这里已经有建筑了，换个位置？” |
| 内容审核 | 名称无违禁词 | “这个名字不太合适，换一个吧~” |

**建筑创建**

- 校验通过后，Agent行为树中注入新的建造任务
- Agent走到空地 → 播放建造动画 → 进度推进 → 完成
- 建筑元数据包含：buildingName, requestedBy, createdAt
- 点击建筑弹出信息面板

**对话历史管理**

- 前端维护每个（用户, Agent）对的对话历史
- 最多保留最近8轮
- 关闭对话框时不清空（同一session内可继续）

### 验收标准

> 走到AI机器人旁边，对它说“帮我在这里建一座纪念碑，叫做四块钱球拍纪念碑”。
> 机器人回复“好名字！我这就开始建造。”
> 机器人走到附近空地开始建造，头顶显示“正在建造：四块钱球拍纪念碑 42%”。
> 建造完成后，点击这座建筑，弹出信息面板显示名称和建造者。
> 尝试第4次建造请求，机器人回复“今天的建造次数用完了”。

---

## Sprint 4（第 7-8 周）：持久化 + 打磨 + 上线

### 目标

让MVP达到可体验、可保存、可展示的状态。

### 任务清单

**持久化**

- 世界状态序列化/反序列化（JSON格式）
- 自动保存触发时机：
  - 建筑建造完成时
  - 用户关闭页面时（beforeunload事件）
  - 每5分钟定时保存
- 页面加载时调用 `/api/load-world` 恢复世界状态
- MongoDB数据结构：

```markdown
// worlds collection
{
  worldId: "default",
  buildings: [...],
  agentStates: [...],
  globalState: { ... },
  updatedAt: Date
}

// conversations collection（可选）
{
  agentId: string,
  messages: [...],
  createdAt: Date
}
```

**视觉打磨**

- 占位几何体替换为Q版模型：
  - AI机器人模型（至少1种，Q版鲨鱼造型）
  - 建筑模型（至少3种：纪念碑/房屋/花园）
  - 玩家角色模型
- 场景装饰：树木/岩石/路灯等环境物件
- 地形美化：简单的颜色分区或纹理
- 建造特效优化（粒子、光效）

**UI打磨**

- 对话框视觉优化（圆角、阴影、动画过渡）
- 建筑信息面板设计（卡片式，显示名称/建造者/时间/缩略图）
- 加载画面（星球旋转 + 进度条 + 加载文案）
- 简单的引导提示（“走到机器人旁边，点击它试试”）

**部署上线**

| 组件 | 部署方案 | 成本 |
|------|---------|------|
| 前端静态资源 | 腾讯云COS + CDN | ~50元/月 |
| 3D资产（模型/贴图） | 腾讯云COS + CDN | 同上 |
| 后端API | 腾讯云CVM 2核4G 或 云函数 | ~150-300元/月 |
| MongoDB | 腾讯云MongoDB 免费版 或 MongoDB Atlas | 0-200元/月 |
| LLM API | DeepSeek/通义千问 按量 | ~10-50元/月 |
| 域名 + HTTPS | — | ~100元/年 |
| **合计** | | **~300-600元/月** |

**基础监控**

- 后端日志：API请求量、LLM响应时间、错误率
- 前端日志：页面加载时间、FPS、Agent数量
- 简单的告警（LLM API调用失败时通知）

### 验收标准

> 分享一个URL链接，任何人用手机浏览器打开：
> 1. 看到加载画面，数秒后进入Q版3D星球
> 2. 用摇杆控制角色行走，看到AI机器人在自主建造
> 3. 走到机器人旁边点击，弹出对话框
> 4. 输入建造请求，机器人回复并执行建造
> 5. 建造完成后点击建筑，看到自己的名字
> 6. 关闭页面，重新打开，之前的建筑还在
> 7. 整个体验流畅，无明显卡顿

---

# 5. 里程碑总览

| 时间点 | 里程碑 | 验收标准 |
|--------|--------|---------|
| 第 2 周末 | **能走进去** | 3D场景可进入，角色可行走 |
| 第 4 周末 | **AI活了** | 机器人在自主建造建筑 |
| 第 6 周末 | **核心链路跑通** | 对话指挥AI建造有名字的建筑 |
| 第 8 周末 | **MVP发布** | 线上可访问，建筑可持久化 |

```markdown
Week  1  2  3  4  5  6  7  8
      ├──┤  ├──┤  ├──┤  ├──┤
      S1     S2     S3     S4
      场景   Agent  对话   上线
      行走   行为树  建造   打磨
```

---

# 6. 风险与应对

| 风险 | 影响 | 应对策略 |
|------|------|---------|
| Babylon.js移动端性能不足 | 手机上卡顿 | 控制面数和纹理大小；降低Agent数量到5个；关闭后处理特效 |
| LLM返回格式不稳定 | 行为指令解析失败 | 多层fallback：先尝试JSON解析，失败则正则提取，再失败则只返回文本无action |
| DeepSeek API不稳定 | 对话功能不可用 | 准备通义千问作为备选；实现自动切换逻辑 |
| Q版3D模型制作耗时 | Sprint 4美术资源不足 | 前3个Sprint用几何体占位即可验证；模型可外包或使用AI生成工具辅助 |
| 8周时间不够 | 功能未完成 | Sprint 3（对话建造）是硬性底线；Sprint 4可适当延长或简化打磨内容 |

---

# 7. MVP 之后的路线

MVP 验证通过后，按优先级叠加功能，逐步演进到完整版：

## P0：多用户同步（约 4 周）

- 引入Socket.IO + 世界服务器
- 世界状态迁移到服务端内存
- 行为树迁移到服务端运行
- 增量广播 + 空间过滤
- 用户账号体系（与现有Taro游戏共享登录态）
- 实时文字聊天（附近 + 全局）

## P1：内容扩展（约 3 周）

- 建筑类型扩充到10-20种
- Agent数量增加到30-50个
- 建筑风格系统（可爱/科幻/复古）
- 更多Agent性格差异化

## P2：系统深化（约 3 周）

- 探索型机器人（Explorer Agent）
- 星球进度系统（接入2D游戏能量贡献）
- 用户贡献排行
- 对话历史查看

## P3：平台扩展

- 微信小程序降级版（Cocos Creator）
- 原生App集成

---

# 附录

## A. 关联文档

| 文档 | 说明 |
|------|------|
| [[SharkStar_3DWorld_TechStack]] | 完整版技术选型与产品方案（含多用户架构） |
| [[SharkStar_WorldView_PRD]] | 世界观PRD |
| [[AMIO_MVP_PRD_完整版_V3]] | 整体MVP产品需求 |

## B. 版本记录

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| V1.0 | 2026-02 | 初版，单用户+AI Agent MVP计划 |

---

> **文档版本**：V1.0
> 
> **AMIO · Keep Us Human**
> 
> **“一个人的星球，也值得被建造。”**
